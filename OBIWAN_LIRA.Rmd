---
title: "OBIWAN PLACEBO VS. TREATMENT ANALYSIS REPORT"
author: "David Munoz Tord"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:  
    includes:
      in_header: header.html
    css: "style.css"
    code_folding: "hide"
    toc: true
    toc_float: false
    number_sections: false
  pdf_document:
    extra_dependencies: ["float"]
repro:
  data:
    HED: data/HEDONIC.csv
    INST: data/INST.csv
    PAV: data/PAV.csv
    PIT: data/PIT.csv
    intern: data/internal.csv
    medic: data/medic.csv
    HED_fMRI: data/HED_fmri.csv
    
  packages: [ aaronpeikert/repro@devel, crsh/papaja@devel, tinylabels, apaTables, MBESS, afex, ggplot2, ggpubr, Rmisc, emmeans, tidyr, BayesFactor, bayestestR, devtools, lspline, kableExtra, sjPlot, knitr, XML, rlist, janitor, optimx, ggthemes, dplyr, JWileymisc, corrplot, caret, intmed, stringr, cowplot, pander, psych, cmdstanr, brms, tidybayes]
  scripts: R/clean.R
  apt:
    - libgsl0-dev
---

### Setup {-}
<!-- # TO DO -->
  
```{r setup, results='hide', message=FALSE, warning=FALSE}

library(repro)
# load packages from yaml header
automate_load_packages()
# include external scripts
automate_load_scripts()

# load data
intern  <- automate_load_data(intern, read.csv, stringsAsFactors = T)
medic    <- automate_load_data(medic, read.csv, stringsAsFactors = T)
PAV      <- automate_load_data(PAV, read.csv, stringsAsFactors = T)
INST     <- automate_load_data(INST, read.csv, stringsAsFactors = T)
PIT      <- automate_load_data(PIT, read.csv, stringsAsFactors = T)
HED      <- automate_load_data(HED, read.csv, stringsAsFactors = T)
HED_fMRI <- automate_load_data(HED_fMRI, read.csv, stringsAsFactors = T)

x = session_info();  opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE) # set F for all


## we recommend running this is a fresh R session or restarting your current session
#install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
#install_cmdstan()


# check_git(); check_make(); check_docker() #check if installed

sessio = session_info(); #opts_chunk$set(echo = F, message=F, warning=F) # set echo F for all
```

This file was automatically created via `the Repro package (version 0.1.0)` using  `r sessio$platform[1]`

<!-- May I suggest running `repro::automate()`? This will create a `Dockerfile` & `Makefile` based on every RMarkdown in this folder and the special yamls in them. date: "`r format(Sys.time(), '%d %B, %Y')`" -->
<!-- add ENV DEBIAN_FRONTEND=noninteractive -->



```{r options, results='hide', message=FALSE, warning=FALSE}
niter = 500; warm = 100; chains = 4; cores = 4; nsim = 10000 # number of iterations (to change if you want to quick check and warmups #or also parallel::detectCores()/2)
options(scipen = 666, warn=-1, contrasts=c("contr.sum","contr.poly"), mc.cores = cores);  #remove scientific notation # remove warnings #set contrasts to sum !
 #cl = parallel::detectCores()/2
set.seed(666) #set random seed
control = lmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')) #set "better" lmer optimizer #nolimit # yoloptimizer
#emm_options(pbkrtest.limit = 8000) #increase repetitions limit for frequentist stats

source('R/plots.R', echo=F)# plot specification
source('R/utils.R', echo=F)# useful functions

panderOptions('knitr.auto.asis', FALSE) #remove auto styling

# Look at R/clean.R (listed in the YAML) which does all the preprocessing for more info

# If you are unsure weather or not you have `git` `make` & `docker`.
# check_git()
# check_make()
# check_docker()
```

```{r clean, echo=FALSE, include=FALSE}
# this chunk runs R/clean.R (listed in the YAML) which does all the preprocessing
```
### Description
TODO blabla\

<!-- Parametric Bootstrap Test method to evaluate significance of fixed effects in mixed-effects models (using MLE fit, nsim = 5000) and Bayes Factor from mixed models (see Wagenmakers, 2007) -->

### Demographics
```{r demographics}
egltable(c("BMI", "AGE", "GENDER"), 
  g = "INTERVENTION", data = df, strict = FALSE) %>%
  kbl(caption ="Summary statistics", digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%
  row_spec(0,bold=T,align='c')
```

### Biomedical data

#### Variable Selection  {-}
```{r var_plot, echo=FALSE, warning=FALSE, cache=TRUE, fig.align="center", out.width="90%", fig.cap="Box-plot of all biomedical predictors per intervention."}

# Boxplot of biomedical variables per group
ggplot(med)+
  geom_boxplot(aes(INTERVENTION, n))+
  facet_wrap(~feature, scales = "free")+
  labs(title = "")+
  theme_fivethirtyeight()+
  theme(axis.title = element_text()) + 
  ylab("Biomedical predictor's value (scaled)") + 
  xlab('')

# Plot correlogram of numeric variables
#pairs(~., data = df[,8:19], main = "Scatterplot Matrix of variables")
#corrplot(cor(df[,8:19], use="pairwise.complete.obs"), type="lower")

```
\

Recursive Feature Eliminations 
```{r var_sel, echo=FALSE, include=T, cached=T,fig.align="center"}

#1) with Recursive Feature Eliminations (CARET)

sizes = 1:length(dfmed[c(-1)]); len = length(sizes)
seeds <- vector(mode = "list", length = len)
for(i in 1:(len-1)) seeds[[i]]<- sample.int(n=nsim, size = length(sizes)+1)
# for the last model
seeds[[len]]<-sample.int(nsim, 1)

RFEcontrol <- rfeControl(functions=rfFuncs, method="cv", number=10, seeds= seeds) # control options

rfeResults = rfe(x = dfmed[c(-1)], y = dfmed$intervention, sizes=sizes, rfeControl=RFEcontrol)
predictors(rfeResults)
plot(rfeResults, type=c("g", "o")) # look for the "elbow"

#if we agree that BMI, Body Weight and Waist Circumference actually measure the same thing, there only 4 other variables that are "useful" to separate the two groups :
#Reelin and GLP

```

#### Mediation analysis  {-}
```{r mediate, echo=FALSE, include=F}

parallel:::setDefaultClusterOptions(setup_strategy = "sequential")

med_res <- intmed::mediate(y = "weightLoss", med = c("GLP_diff" ,  "reelin_diff"),  treat = "intervention", ymodel = "regression", mmodel = c("regression", "regression"), treat_lv = 1, control_lv = 0, incint = TRUE, inc_mmint = FALSE, conf.level = 0.95, data = df, sim = nsim, complete_analysis = TRUE, digits = 3,  summary_report=F) #c = c("age","gender"),

table <- list.clean(readHTMLTable("res.html"), fun = is.null, recursive = FALSE); table = table[3]$`NULL`[1:6,]

```

```{r mediate_res, echo=FALSE, include=T}

#pander(table)
colnames(table)[4] = "p"; table$p = as.numeric(table$p); table$p = ifelse(as.numeric(table$p) < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",table$p), "</span>"),  paste("<span>" ,sprintf("%.3f",table$p), "</span>")) # highlight p < 0.05
table$p = ifelse(table$p == '<span style=" font-weight: bold; " > 0.000 </span>', "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>", table$p)


table %>%
  kbl(caption ="Mediation Analysis: DV = Weight loss, IV = Intervention", escape=F) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)

#just for plot purpose (because not the same exact analysis)
medi =  psych::mediate(weightLoss ~ intervention + (GLP_diff) + (reelin_diff), data = df, n.iter = nsim, plot=F); psych::mediate.diagram(medi, show.c=FALSE)
```

### Weight Loss
```{r weigth_loss,  include=FALSE, cache=F}

# Model
mf = formula(weightLoss ~ intervention + gender + age + GLP_diff + reelin_diff  + (1|id))

# -------------------------------------- Bayesian Regression Models using Stan -------------------------------------
# STAN is a probabilistic programming language that allows you to get full Bayesian statistical inference with MCMC sampling.
bmod_full = brm(mf, data=df, family = gaussian, prior = c(prior(normal(0, 3), class = "b", coef = ""), prior(normal(0, 100), class = "Intercept", coef = "")), sample_prior = T, save_pars = save_pars(all = TRUE), chains = chains,  iter = niter, warmup = warm, seed = 123, inits = 1, backend = 'cmdstanr', threads = threading(4)) # a lot to unwind here..  1) Generic informative prior around 0 for fixed effects and weak prior for the intercept 2) we need to sample priors and save parameters for computing BF  

#lmer to compare
fmod_full = lm(update(mf, ~.- (1|id)) , data = df)
```

```{r message = FALSE, results='hide', fig.align="center", out.width = "100%", dpi = 200}

## plot population-level effects posterior distributions and chain sampling

param = mcmc_plot(object = bmod_full, pars =c("b_.*en", "b_.*ge"), type ="areas")

trace = mcmc_plot(object = bmod_full, pars =c("b_.*en", "b_.*ge"), type ="trace")


#check assumptions
var_group = pp_check(bmod_full, type = "stat_grouped", group = "intervention", binwidth = 0.1, nsamples = NULL) #equality of variance between groups

rep_fit = pp_check(bmod_full, nsamples = 100) # check response fit

error = pp_check(bmod_full, type ="error_scatter_avg", nsamples = NULL) # check good alignment between model and data, and no obvious pattern to the types of errors we are getting.


#Normality of errors
residuals <-residuals(bmod_full)[, 1]; res <- qqnorm(residuals, pch = 1, plot.it=F)

lmx = plot_model(fmod_full, type = "diag"); #diagnostic plots for lmer

#plot all
diagRT <- ggarrange(param, var_group, rep_fit, error, ncol = 2, nrow = 2)

annotate_figure(diagWEIGHT, top = text_grob("Diagnostic Plots", face = "bold", size = 10))
```



```{r WEIGHT_tab, include=FALSE, cache=F}

full_tab = describe_posterior(bmod_full,
                   estimate = "median", dispersion = T,
                   ci = .9, ci_method = "hdi",
                   bf_prior = bmod_full, diagnostic = "Rhat",  
                   test = c("p_direction", "bf"))

full_tab = filter(full_tab, Parameter %notin% c("b_Intercept", "prior_sigma"))



# -------------------------------------- FREQUENTIST STATS: AOV -----------------------------------------------

# formula = 'weightLoss ~ intervention + gender + age  + Error(id)'
# 
# 
# mdl.weight = aov_car(as.formula(formula), data = df, factorize = FALSE,  anova_table = list(correction = "GG", es = "pes"),type = "II")
# res = nice(mdl.weight, MSE = F); ref_grid(mdl.weight); res
# 
# PES.weight = pes_ci(as.formula(formula), data = df, conf.level = .90, factorize = FALSE, anova.type = "II", epsilon="none") ; 
# mdl.weight.emms = emmeans(mdl.weight, pairwise ~ intervention)


# res$p.value = as.numeric(res$p.value)
# res$p.value = ifelse(res$p.value < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",res$p.value), "</span>"),  paste("<span>" ,sprintf("%.3f",res$p.value), "</span>"))
# 
# res$F = unlist(str_split(gsub("[^0-9.,-]", "", res$F), ","));res$pes = unlist(str_split(gsub("[^0-9.,-]", "", res$pes), ","));
# res$`90% CI` = paste(sprintf("%.3f",PES.weight[,2]), "-", sprintf("%.3f",PES.weight[,3]))
# 
# res$p.value[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
# colnames(res)[3:5] = c( paste("F(", res$df[1], ")", sep=""),"&eta;<sub>p</sub><sup>2</sup>", "p")
# res[c(1,4,6,3,5)]  %>% kbl(digits = 2, escape = F) %>%
#   kable_styling(latex_options = "striped", position = "center", full_width = F) 

# -------------------------------------- Regression table summary --------------------------------------

tab_model(bmod_full, show.p = F, show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 3, dv.labels = "Weight Loss (\u0394 BMI)", file = "tmp/temp1.html", transform = NULL,  rm.terms = "beta")

report = capture.output(sexit(bmod_full, ci=.9))

```


```{r WEIGHT_res}

print(paste("Bayesian linear mixed model (estimated using MCMC sampling with " ,chains ," chains of", niter, " iterations and a warmup of", warm, ") to predict weightLoss with intervention, gender, age, GLP_diff and reelin_diff (formula: weightLoss ~ intervention + gender + age + GLP_diff + reelin_diff). The model included id as random effect (formula: ~1 | id). Priors over parameters were set as normal (mean = 0.00, SD = 3.00), and student_t (location = 0.00, scale = 2.50) distributions"))
            

full_tab

report[4]

tables <- list.clean(readHTMLTable("tmp/temp1.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)
tables2 <- as.matrix(tables2) %>% as_tibble();


tables2[is.na(tables2)] <- "";  names(tables2) <- NULL; tmp = t(tables2[(length(full_tab$Parameter)+1):(length(full_tab$Parameter)+4),1:2]);
tmp[,4][1] = "R2"; tmp[,4][2] = gsub(".*/","",tmp[,4][2]); colnames(tmp) =  tmp[1,]
pander:: pander(tmp[2,])


```

#### Plot Weight Loss {-}
```{r Weight_Loss, echo=FALSE, warning=FALSE, cache=TRUE, fig.align="center", fig.cap="Weight Loss by intervention."}


dfdraws = bmod_full %>%
    spread_draws(`b_intervention` )


HDI_weight = plotHDI( dfdraws$`b_intervention` , credMass = .90, binSize = 100, Title = "") + theme_bw() + html_theme  


dfdraws2 =  bmod_full %>%
     emmeans(~ intervention) %>%
     gather_emmeans_draws() 


pp = dfdraws2 %>%
    ggplot(aes(x = as.factor(intervention) , y = .value,  fill = as.factor(intervention))) +
    geom_abline(slope= 0, intercept=0, linetype = "dashed", color = "black") +
    stat_slab(.width = c(0.50, 0.9), position="dodge", alpha=0.5) +
    stat_pointinterval(.width = c(0.50, 0.9),position="dodge") +
    labs(x = "",y = "Weight Loss (\u0394 BMI)", title = "") + 
    scale_fill_manual(values=c("-1" = pal[1],"1"=pal[6]), guide="none") +
    scale_color_manual( values=c("-1" = pal[1],"1"=pal[6]), guide="none") +
    scale_x_discrete(labels=c("Placebo", "Liraglutide")) +
  #scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(400,550, by = 50)), limits = c(380,575)) +
    theme_bw()

plt_bayes_html = pp + html_theme 
plt_bayes = pp + averaged_theme 


figureWL <- ggarrange(plt_bayes_html, HDI_weight,
                    labels = c("A", "B"),
                    ncol = 2)
#figureWL




dfR <- summarySE(df, measurevar = "weightLoss",
                 groupvars = "INTERVENTION")

dfR$cond <- ifelse(dfR$INTERVENTION == "Liraglutide", -0.25, 0.25)
df$cond <- ifelse(df$INTERVENTION == "Liraglutide", -0.25, 0.25)
df <- df %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                    grouping = interaction(id, cond))

pp <- ggplot(df, aes(x = cond, y = weightLoss, 
                     fill = INTERVENTION, color = INTERVENTION)) +
  geom_hline(yintercept=0, linetype="dashed", size=0.4, alpha=0.8) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = INTERVENTION, color = NA))+
  geom_point(aes(x = condjit), alpha = .3,) +
  geom_crossbar(data = dfR, aes(y = weightLoss, ymin=weightLoss-se, ymax=weightLoss+se), width = 0.2 , alpha = 0.1)+
  ylab('Weight loss (\u0394 BMI)')+xlab('')+
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(-2.5,7.5, by = 2.5)), limits = c(-3,8)) +
  scale_x_continuous(labels=c("Liraglutide", "Placebo"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("Liraglutide"= pal[6], "Placebo"=  pal[1]), guide = 'none') +
  scale_color_manual(values=c("Liraglutide"= pal[6], "Placebo"=  pal[1]), guide = 'none') +
  theme_bw() 

plt = pp + averaged_theme 
pp + html_theme 
```
\
\
```{r weight_saveFIG, include=FALSE}
cairo_pdf('figures/Figure_WL_Lira.pdf')
print(plt)
dev.off()

cairo_pdf('figures/Figure_WL_Lira_Bayes.pdf')
print(figureWL)
dev.off()
```

### Pavlvovian Conditioning Task 

#### Latency {-}
Latency = time to detect the target (ms) & condition = CS+ or CS-
```{r PAV_RT, include=FALSE, cache=F}

# Model
mf = formula(RT ~ condition*intervention*session + age + gender + BMI_V1  + hungry + GLP_diff + reelin_diff + (condition*session|id) + (1|trialxcondition))


# -------------------------------------- Bayesian Regression Models using Stan -------------------------------------
# STAN is a probabilistic programming language that allows you to get full Bayesian statistical inference with MCMC sampling.
bmod_full = brm(mf, data=PAV.clean, family = exgaussian, prior = c(prior(normal(0, 3), class = "b", coef = ""), prior(normal(0, 100), class = "Intercept", coef = "")), sample_prior = T, save_pars = save_pars(all = TRUE), chains = chains,  iter = niter, warmup = warm, seed = 123, inits = 1, backend = 'cmdstanr', threads = threading(4), max_treedepth=15) # a lot to unwind here..  1) Generic informative prior around 0 for fixed effects and weak prior for the intercept 2) we need to sample priors and save parameters for computing BF  3) account for the skewness of reaction times #family = "exgaussian"


#lmer to compare
fmod_full = lmer(mf , data = PAV.clean, REML=F, control = control )
```


```{r message = FALSE, results='hide', fig.align="center", out.width = "100%", dpi = 200}

## plot population-level effects posterior distributions and chain sampling

param = mcmc_plot(object = bmod_full, pars =c("b_.*o", "b_.*y", "b_.*ge", "b_.*diff", "b_.*V1"), type ="areas")

trace = mcmc_plot(object = bmod_full, pars =c("b_.*o", "b_.*y", "b_.*ge", "b_.*diff", "b_.*V1"), type ="trace")


#check assumptions
var_group = pp_check(bmod_full, type = "stat_grouped", group = "intervention", binwidth = 1, nsamples = NULL) #equality of variance between groups

rep_fit = pp_check(bmod_full, nsamples = 10) # check response fit -> accounting for skewness, nice!

error = pp_check(bmod_full, type ="error_scatter_avg", nsamples = NULL) # check good alignment between model and data, and no obvious pattern to the types of errors we are getting.


#Normality of errors
residuals <-residuals(bmod_full)[, 1]; res <- qqnorm(residuals, pch = 1, plot.it=F)

lmx = plot_model(fmod_full, type = "diag"); #diagnostic plots for lmer

#plot all
diagRT <- ggarrange(param, var_group, rep_fit, error, ncol = 2, nrow = 2)

annotate_figure(diagRT, top = text_grob("Diagnostic Plots", face = "bold", size = 10))
```

```{r PAV_tab, include=FALSE, cache=F}

full_tab = describe_posterior(bmod_full,
                   estimate = "median", dispersion = T,
                   ci = .9, ci_method = "hdi",
                   bf_prior = bmod_full, diagnostic = "Rhat",  
                   test = c("p_direction", "bf"))

full_tab = filter(full_tab, Parameter %notin% c("b_Intercept", "prior_beta", "prior_sigma"))



# -------------------------------------- FREQUENTIST STATS: LRT -----------------------------------------------
measurevar = "RT"
# formula = "condition*intervention*session"
# COVA = "+ condition*age + gender + BMI_V1  + thirsty  + hungry +"
# random = " (condition*session|id) + (1|trialxcondition)"
# 
# #method LRT 
# model = mixed(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = PAV, method = "LRT", control = control, REML = FALSE); model
# 
# table = nice(model);  ref_grid(model)  #triple check everything is centered at 0
# 
# 
# mod =  lmer(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = PAV, control = control)

# tab_model(mod, show.p = T,show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 2, dv.labels = "Latency", emph.p = TRUE, file = "tmp/temp1.html")

# tables <- list.clean(readHTMLTable("tmp/temp1.html"), fun = is.null, recursive = FALSE)
# tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)
# 
# tables2 <- as.matrix(tables2) %>% as_tibble()
# tables2[is.na(tables2)] <- ""
# tables3 = tables2[1:length(table$Effect),1:4] 
# tables3[5] = str_split(gsub("[^0-9.,-]", "", table[3]), ",")[[1]]; tables3[6] = as.numeric(str_split(gsub("[^0-9.,-]", "", table[4]), ",")[[1]]); 
# tables3$...6 = ifelse(tables3$...6 < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",tables3$...6), "</span>"),  paste("<span>" ,sprintf("%.3f",tables3$...6), "</span>"))
# colnames(tables3)[5] = "\u03C7\u00B2"; colnames(tables3)[6] = "p"
# tables3$p[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
# tables3 %>%   
#   kbl(caption ="Latency (ms)",escape = F) %>%
#   kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T,align='c')
# tmp = tables2[(length(table$Effect)+1):(length(table$Effect)+5),1:2]
# names(tmp) <- NULL
# tmp1 <- data.frame(t(tmp[-1]))
# colnames(tmp1) <- tmp[[1]]
# tmp1 %>% kbl(digits = 2) %>%
#   kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) 


# -------------------------------------- Regression table summary --------------------------------------

tab_model(bmod_full, show.p = F, show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 3, dv.labels = "Latency (ms)", file = "tmp/temp2.html", transform = NULL,  rm.terms = "beta")

report = capture.output(sexit(bmod_full, ci=.9))

```


```{r PAV_res}

print(paste("Bayesian general linear mixed model (exgaussian family with a identity link) (estimated using MCMC sampling with " ,chains ,"chains of", niter, "iterations and a warmup of", warm, ") to predict RT with condition, intervention, session, age, gender, BMI_V1, hungry, GLP_diff and reelin_diff (formula: RT ~ condition * intervention * session + age + gender + BMI_V1 + hungry + GLP_diff + reelin_diff). The model included condition, session, id and trialxcondition as random effects (formula: list(~condition * session | id, ~1 | trialxcondition)). Priors over parameters were set as normal (mean = 0.00, SD = 3.00), and student_t (location = 0.00, scale = 130.20) distributions"))
            

full_tab

report[4]; report[16]

tables <- list.clean(readHTMLTable("tmp/temp2.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)
tables2 <- as.matrix(tables2) %>% as_tibble()


tables2[is.na(tables2)] <- "";  names(tables2) <- NULL; tmp = t(tables2[(length(full_tab$Parameter)+1):(length(full_tab$Parameter)+5),1:2]);
tmp[,5][1] = "R2"; tmp[,5][2] = gsub(".*/","",tmp[,5][2]); colnames(tmp) =  tmp[1,]
pander:: pander(tmp[2,])


```
\

#### Plot Latency {-}
```{r PAV_RT_plot, message=FALSE, warning=FALSE, cache=F, fig.align="center", fig.cap="A) Posterior distribution by Pavlovian cue. B) Highest density interval (90% HDI) of the posterior distribution difference for the latency to respond between CS+ and CS-"}


dfdraws = bmod_full %>%
    spread_draws(`b_condition` )


HDI_RT = plotHDI( dfdraws$`b_condition` , credMass = .90, binSize = 100, Title = "") + theme_bw() + html_theme  


dfdraws2 =  bmod_full %>%
     emmeans(~ condition) %>%
     gather_emmeans_draws() 


pp = dfdraws2 %>%
    ggplot(aes(x = as.factor(condition) , y = .value,  fill = as.factor(condition))) +
    #geom_abline(slope= 0, intercept=0, linetype = "dashed", color = "black") +
    stat_slab(.width = c(0.50, 0.9), position="dodge", alpha=0.5) +
    stat_pointinterval(.width = c(0.50, 0.9),position="dodge") +
    labs(x = "", y = "Latency (ms)", title = "") + 
    scale_fill_manual(values=c("-1" = pal[1],"1"=pal[2]), guide="none") +
    scale_color_manual( values=c("-1" = pal[1],"1"=pal[2]), guide="none") +
    scale_x_discrete(labels=c("CS-", "CS+")) +
  #scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(400,550, by = 50)), limits = c(380,575)) +
    theme_bw()

plt_bayes_html = pp + html_theme 
plt_bayes = pp + averaged_theme 


figureRT <- ggarrange(plt_bayes_html, HDI_RT,
                    labels = c("A", "B"),
                    ncol = 2)
#figureRT



# RT
labels <- c("-1" = "Pre", "1" = "Post")

dfR <- summarySEwithin(PAV.means,
                       measurevar = "RT",
                       withinvars = c("condition","session"), 
                       idvar = "id")

dfR$cond <- ifelse(dfR$condition == "1", -0.25, 0.25)
PAV.means$cond <- ifelse(PAV.means$condition == "1", -0.25, 0.25)
PAV.means <- PAV.means %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                                  grouping = interaction(id, cond))

pp <- ggplot(PAV.means, aes(x = cond, y = RT, 
                            fill = as.factor(condition), color = as.factor(condition))) +
  geom_line(aes(x = condjit, group = id, y = RT), alpha = .3, size = 0.5, color = 'gray') +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = as.factor(condition), color = NA))+
  geom_point(aes(x = condjit, shape = as.factor(intervention)), alpha = .3,) +
  geom_crossbar(data = dfR, aes(y = RT, ymin=RT-se, ymax=RT+se), width = 0.2 , alpha = 0.1)+
  ylab('Latency (ms)')+
  xlab('Conditioned stimulus')+
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(200,1000, by = 200)), limits = c(150,1050)) +
  scale_x_continuous(labels=c("CS+", "CS-"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_color_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2)) +
  theme_bw() + facet_wrap(~session, labeller=labeller(session = labels))

plt = pp + averaged_theme  + theme(legend.position=c(.96,.94), axis.text.x = element_text(size = 14))
pp + html_theme  + theme(legend.position=c(.96,.94), axis.text.x = element_text(size = 14))
```
```{r PAV_RT_saveFIG, include=FALSE}
cairo_pdf('figures/Figure_PavlovianRT_Lira.pdf')
print(plt)
dev.off

cairo_pdf('figures/Figure_PavlovianRT_Lira_Bayes.pdf')
print(figureRT)
dev.off()
```

#### Perceived liking (Pavlovian Cue) {-}

Ratings = how pleasant is the clue (0-100, no repetitions)   &   condition = CS+ or CS-
```{r PAV_Lik, include=FALSE, message=FALSE, cache=F}
# Model
mf = formula(liking ~ condition*intervention*session + age + gender + BMI_V1  + hungry + GLP_diff + reelin_diff + (condition*session|id))

# -------------------------------------- Bayesian Regression Models using Stan -------------------------------------
bmod_full = brm(mf, data=PAV.means, family = gaussian, prior = c(prior(normal(0, 3), class = "b", coef = ""), prior(normal(0, 100), class = "Intercept", coef = "")), sample_prior = T, save_pars = save_pars(all = TRUE), chains = 4,  iter = 5000, warmup = 1000, seed = 123, inits = 1, backend = 'cmdstanr', threads = threading(4))  # a lot to unwind here..  1) Generic weakly informative prior around 0 for fixed effects and very weak prior for the intercept 2) we need to sample priors and save parameters for computing BF  


#lmer to compare
fmod_full <- lmer(update(mf, ~ .-(condition*session|id)+(condition+session|id)) , data=PAV.means) #cannot maximize random structure here
```

```{r message = FALSE, results='hide', fig.align="center", out.width = "100%", dpi = 200}

## plot population-level effects posterior distributions and chain sampling

param = mcmc_plot(object = bmod_full, pars =c("b_.*o", "b_.*y", "b_.*ge", "b_.*diff", "b_.*V1"), type ="areas")

trace = mcmc_plot(object = bmod_full, pars =c("b_.*o", "b_.*y", "b_.*ge", "b_.*diff", "b_.*V1"), type ="trace")


#check assumptions
var_group = pp_check(bmod_full, type = "stat_grouped", group = "intervention", binwidth = 1, nsamples = NULL) #equality of variance between groups

rep_fit = pp_check(bmod_full, nsamples = 10) # check response fit 

error = pp_check(bmod_full, type ="error_scatter_avg", nsamples = NULL) # check good alignment between model and data, and no obvious pattern to the types of errors we are getting.


#Normality of errors
residuals <-residuals(bmod_full)[, 1]; res <- qqnorm(residuals, pch = 1, plot.it=F)

lmx = plot_model(fmod_full, type = "diag"); #diagnostic plots for lmer

#plot all
diagLik <- ggarrange(param, var_group, rep_fit, error, ncol = 2, nrow = 2)

annotate_figure(diagLik, top = text_grob("Diagnostic Plots", face = "bold", size = 10))
```


```{r PAV_tab_lik, include=FALSE, cache=F}

full_tab = describe_posterior(bmod_full,
                   estimate = "median", dispersion = T,
                   ci = .9, ci_method = "hdi",
                   bf_prior = bmod_full, diagnostic = "Rhat",  
                   test = c("p_direction", "bf"))

full_tab = filter(full_tab, Parameter %notin% c("b_Intercept", "prior_beta", "prior_sigma"))



# -------------------------------------- FREQUENTIST STATS: -----------------------------------------------

# measurevar = "liking"
# formula = "condition*intervention*session"
# COVA = "+ age + gender + BMI_V1 + "
# random = "Error(id/session*condition)"
#  
# mdl.lik = aov_car(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data= PAV.means, factorize = F, anova_table = list(correction = "GG", es = "pes"))
# res = nice(mdl.lik, MSE=F);  res = res[c(10,1:6,11,15,16),] #clean up unesuful an reorder
# ref_grid(mdl.lik)  #triple check everything is centered at 0
# 
# #calculate Partial eta-squared and its 90 % CI for each effect
# PES.lik = pes_ci(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = PAV.means, conf.level = .90, factorize = FALSE, anova.type = "II", epsilon="none") ;  PES.lik = PES.lik[c(10,1:6,11,15,16),]
# mdl.lik.emms = emmeans(mdl.lik, pairwise ~ condition)
# 
# res$p.value = as.numeric(res$p.value)
# res$p.value = ifelse(res$p.value < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",res$p.value), "</span>"),  paste("<span>" ,sprintf("%.3f",res$p.value), "</span>"))
# 
# res$F = unlist(str_split(gsub("[^0-9.,-]", "", res$F), ","));res$pes = unlist(str_split(gsub("[^0-9.,-]", "", res$pes), ","));
# res$`90% CI` = paste(sprintf("%.3f",PES.lik[,2]), "-", sprintf("%.3f",PES.lik[,3]))
# 
# res$p.value[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
# res$pes[c(5,7,8)]= c("\u003C 0.001")
# colnames(res)[3:5] = c( paste("F(", res$df[1], ")", sep=""),"&eta;<sub>p</sub><sup>2</sup>", "p")
# res[c(1,4,6,3,5)]  %>% kbl(digits = 2, escape = F,row.names = F)  %>%
#   kable_styling(latex_options = "striped", position = "center", full_width = F) 

# -------------------------------------- Regression table summary --------------------------------------

tab_model(fmod_full, show.p = F, show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 3, dv.labels = "Perceived liking", file = "tmp/temp3.html", rm.terms = "beta")

report = capture.output(sexit(bmod_full, ci=.9))

```


```{r PAV_res_lik}

print(paste("Bayesian linear mixed model (estimated using MCMC sampling with" ,chains ," chains of", niter, " iterations and a warmup of", warm, ")  to predict liking with condition, intervention, session, age, gender, BMI_V1, hungry, GLP_diff and reelin_diff (formula: liking ~ condition * intervention * session + age + gender + BMI_V1 + hungry + GLP_diff + reelin_diff). The model included condition, session and id as random effects (formula: ~condition * session | id). Priors over parameters were set as normal (mean = 0.00, SD = 3.00), and student_t (location = 0.00, scale = 15.10) distributions"))

full_tab

report[4]; report[10]
tables <- list.clean(readHTMLTable("tmp/temp3.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)
tables2 <- as.matrix(tables2) %>% as_tibble()


tables2[is.na(tables2)] <- "";  names(tables2) <- NULL; tmp = t(tables2[(length(full_tab$Parameter)+1):(length(full_tab$Parameter)+4),1:2]);
tmp[,4][1] = "R2"; tmp[,4][2] = gsub(".*/","",tmp[,2][2])
pander::pander(tmp[,1:2])
```
\
\


#### Plot Perceived liking (Pavlovian Cue) {-}
```{r PAV_lik_plot, message=FALSE, warning=FALSE, cache=F, fig.align="center", fig.cap="A) Posterior distribution by Pavlovian cue. B) Highest density interval (90% HDI) of the posterior distribution difference for the latency to respond between CS+ and CS-"}

dfdraws = bmod_full %>%
    spread_draws(`b_condition`,`b_hungry` )


HDI_cond_PAV = plotHDI( dfdraws$`b_condition` , credMass = .90, binSize = 100, Title = "") + theme_bw()

HDI_hunger_PAV = plotHDI( dfdraws$`b_hungry` , credMass = .90, binSize = 100, Title = "") + theme_bw() # also mcmc_plot(object = bmod_full, pars =c("b_hungry"), type ="areas", prob = 0.9)



dfdraws2 =  bmod_full %>%
     emmeans(~ condition) %>%
     gather_emmeans_draws() 


pp = dfdraws2 %>%
    ggplot(aes(x = as.factor(condition) , y = .value,  fill = as.factor(condition))) +
    geom_abline(slope= 0, intercept=0, linetype = "dashed", color = "black") +
    #geom_point(position = "jitter") +
    stat_slab(.width = c(0.50, 0.9), position="dodge", alpha=0.5) +
    stat_pointinterval(.width = c(0.50, 0.9),position="dodge") +
    ylab('Perceived liking')+
    xlab('')+
    scale_fill_manual(values=c("-1" = pal[1],"1"=pal[2]), guide="none") +
    scale_color_manual( values=c("-1" = pal[1],"1"=pal[2]), guide="none") +
    scale_x_discrete(labels=c("CS-", "CS+")) +
     scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,100, by = 25)), limits = c(-0.05,100.5)) +
    theme_bw()# + facet_wrap(~group, labeller=labeller(group =labels))

plt_bayes_html = pp + html_theme 
plt_bayes = pp + averaged_theme 

figurePAV <- ggarrange(plt_bayes_html, HDI_cond_PAV,
                    labels = c("A", "B"),
                    ncol = 2)
#figurePAV


# Liking

dfL <- summarySEwithin(PAV.means,
                       measurevar = "liking",
                       withinvars = c("condition", "session"), 
                       idvar = "id")

dfL$cond <- ifelse(dfL$condition == "1", -0.25, 0.25)


pp <- ggplot(PAV.means, aes(x = cond, y = liking, 
                            fill = as.factor(condition), color = as.factor(condition))) +
  geom_hline(yintercept=50, linetype="dashed", size=0.4, alpha=0.8) +
  geom_line(aes(x = condjit, group = id, y = liking), alpha = .3, size = 0.5, color = 'gray' ) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill =  as.factor(condition), color = NA)) +
  geom_point(aes(x = condjit, shape =  as.factor(intervention)), alpha = .3) +
  geom_crossbar(data = dfL, aes(y = liking, ymin=liking-se, ymax=liking+se), width = 0.2 , alpha = 0.1)+
  ylab('Liking Ratings')+
  xlab('Conditioned stimulus')+
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,100, by = 25)), limits = c(-0.05,100.5)) +
  scale_x_continuous(labels=c("CS+", "CS-"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_color_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2)) +
  theme_bw()+ facet_wrap(~session, labeller=labeller(session = labels))


plt = pp + averaged_theme  + theme(legend.position=c(.96,.94), axis.text.x = element_text(size = 14))
pp + html_theme  + theme(legend.position=c(.96,.94), axis.text.x = element_text(size = 14))
```
\
\
```{r PAV_lik_saveFIG, include=FALSE}
cairo_pdf('figures/Figure_PavlovianLiking_Lira.pdf')
print(plt)
dev.off()

cairo_pdf('figures/Figure_PavlovianLiking_Lira_Bayes.pdf')
print(figurePAV)
dev.off()
```

### Instrumental Conditioning Task
grips = number of times participant exceeded the force threshold to acquire the reward (Milkshake)
\

```{r INST, include=FALSE, cache=F}

# Model
mf1 = formula(grips ~ trial*intervention*session + hungry + (session|id) + (1|trial)) # LINEAR FIT  
mf2 = formula(grips ~  lspline(trial,5)*intervention*session + hungry + (session|id) + (1|trial)) # PIECEWISE REGRESSION WITH SPLINE AT 5

# -------------------------------------- Bayesian Regression Models using Stan -------------------------------------
linmod = brm(mf1, data=INST, family = gaussian, prior = c(prior(normal(0, 3), class = "b", coef = ""), prior(normal(0, 100), class = "Intercept", coef = "")), sample_prior = T, save_pars = save_pars(all = TRUE), chains = chains,  iter = niter, warmup = warm, seed = 123, inits = 1, backend = 'cmdstanr', threads = threading(4))  # a lot to unwind here..  1) Generic weakly informative prior around 0 for fixed effects and very weak prior for the intercept 2) we need to sample priors and save parameters for computing BF  

splinemod = update(linmod, formula. = mf2)

linmod$loo = loo(linmod); splinemod$loo = loo(splinemod)
comp = loo::loo_compare(linmod$loo, splinemod$loo) 

bmod_full = splinemod #winner model

#lmer to compare
fmod_full = lmer(mf2 , data = INST, REML=F, control = control )
```

```{r INST, cache=TRUE,  include=FALSE, message=FALSE, warning=FALSE}

measurevar = "grips"
formula = "intervention*session"
COVA = "+ age + gender + BMI_V1  + session*thirsty  + hungry +"
random = '(session|id) + (1|trial)'

model = mixed(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = INST, method = "LRT", control = control, REML = FALSE); model

## FACTORIAL EARLY/LATE LEARNING PHASIS
facmod <- lm(grips ~ phasis*session,data=dfTrial)
#LINEAR FIT
linmod <- lm(grips ~ Trial*session,data=dfTrial)
## QUADRATIC FIT  
quadmod <- lm(grips ~ T2*session,data=dfTrial)
## PIECEWISE REGRESSION WITH SPLINES
splinemod <- lm(grips ~ lspline(Trial,-1.07)*session,data=dfTrial) #1.07 = the standardized end of early phase of learning

BF_fit = as_tibble(bayesfactor_models(facmod, linmod, quadmod, splinemod, denominator = facmod)); 
```
```{r INST_learning_MS, cache=TRUE}
#print('BF10 for model piecewise regression model ')
#BF_fit$BF[2]
BF_fit$Model = c("Factorial early/late Learning Phasis", "Linear Time Fit", "Quadratic Time Fit", "Piecewise Regression with Splines")
BF_fit$BF10 = formatC(BF_fit$BF, format = "e", digits = 2); BF_fit$BF10[1] = 1; BF_fit = BF_fit[-c(2)]
kbl(as_tibble(BF_fit), caption = "Bayesian Model Comparison", digits = 1) %>%   kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)  %>%  row_spec(0,bold=T,align='c')
```
\
```{r INST_m, cache=TRUE,  include=FALSE, message=FALSE, warning=FALSE}
mod <- lmer(as.formula(paste(measurevar, paste(formula, COVA, random), sep="~")),data=INST, control = control)

table = nice(model);  ref_grid(model)

tab_model(mod, show.p = F,show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 2, dv.labels = "Grips", emph.p = TRUE, file = "tmp/temp3.html")
```
\
```{r INST_mod}
tables <- list.clean(readHTMLTable("tmp/temp3.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)

tables2 <- as.matrix(tables2) %>% as_tibble()
tables2[is.na(tables2)] <- ""
tables3 = tables2[1:length(table$Effect),1:4] 
tables3[5] = str_split(gsub("[^0-9.,-]", "", table[3]), ",")[[1]]; tables3[6] = as.numeric(str_split(gsub("[^0-9.,-]", "", table[4]), ",")[[1]]); 
tables3$...6 = ifelse(tables3$...6 < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",tables3$...6), "</span>"),  paste("<span>" ,sprintf("%.3f",tables3$...6), "</span>"))

colnames(tables3)[5] = "\u03C7\u00B2"; colnames(tables3)[6] = "p"
# tables3$p[3]= "<span style=\" font-weight: bold;    \" >\u003C 0.300</span>"
tables3 %>% kbl(caption ="Grips",escape = F ) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T,align='c')
tmp = tables2[(length(table$Effect)+1):(length(table$Effect)+5),1:2]
names(tmp) <- NULL
tmp1 <- data.frame(t(tmp[-1]))
colnames(tmp1) <- tmp[[1]]
tmp1 %>% kbl(digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) 

```
\
```{r message = FALSE, echo=FALSE, results='hide', fig.show="hold", out.width="25%", fig.align="center", fig.cap = 'Model assumptions.', warning=F}
x = plot_model(mod, type = "diag")
x[-c(2)]
x[2][[1]]$id
 #check assumptions
```
\
\
```{r INST_plot, echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.align="center", fig.cap="Number of Grips over time by session."}
INSTPRE = subset(INST, session == 0)
INSTPOST = subset(INST, session == 1)

#--------------------------PRE
dfTRIAL <- summarySEwithin(INSTPRE, na.rm=TRUE,
                           measurevar = "grips",
                           withinvars = c("trial","session"),
                           idvar = "id")

dfTRIAL$trial       <- as.numeric(dfTRIAL$trial)

dfTRIALg <- summarySEwithin(INSTPRE, na.rm=TRUE,
                            measurevar = "grips",
                            withinvars = c("trial","session"),
                            betweenvars = "intervention",
                            idvar = "id")

dfTRIALg$trial       <- as.numeric(dfTRIALg$trial)

dfTRIAL$x = dfTRIAL$trial; dfTRIAL$y = dfTRIAL$grips
splinelm <- lm(y ~ lspline(x, 5), data=dfTRIAL)

pp <- ggplot(dfTRIAL, aes(x =trial, y = grips)) +
  geom_point(data = dfTRIALg, aes(shape = intervention), alpha = 0.3, color = 'black') +
  geom_point(data = dfTRIAL, aes(fill = "Mean"), alpha = 0.5, color = pal[4], shape = 18) +
  geom_smooth(method="lm", formula=formula(splinelm), color="tomato",fill = pal[4], size=0.7) + #addd this for lsplines
  ylab('')+
  xlab('') +
  ggtitle("Pre") +
  scale_y_continuous(expand = c(0, 0),  limits = c(11.5,15.5),  breaks=c(seq.int(12,15, by = 1))) +
  scale_x_continuous(expand = c(0, 0),  limits = c(0,15.2),  breaks=c(1,5,10,15)) +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2, 18)) +
  scale_fill_discrete(name="") +
  guides(shape = FALSE) + 
  theme_bw()

pltpre = pp + averaged_theme + theme(axis.text.x= element_text(size = 14), axis.text.y= element_text(size = 14), legend.position=c(.94,.99), plot.title = element_text(hjust = 0.5, size = 20), plot.margin = unit(c(0, 1,-1.5,-2), "cm"))

#-------------------------------POST
dfTRIAL <- summarySEwithin(INSTPOST, na.rm=TRUE,
                           measurevar = "grips",
                           withinvars = c("trial","session"),
                           idvar = "id")

dfTRIAL$trial       <- as.numeric(dfTRIAL$trial)

dfTRIALg <- summarySEwithin(INSTPOST, na.rm=TRUE,
                            measurevar = "grips",
                            withinvars = c("trial","session"),
                            betweenvars = "intervention",
                            idvar = "id")

dfTRIALg$trial       <- as.numeric(dfTRIALg$trial)

dfTRIAL$x = dfTRIAL$trial; dfTRIAL$y = dfTRIAL$grips

pp <- ggplot(dfTRIAL, aes(x =trial, y = grips)) +
  geom_point(data = dfTRIALg, aes(shape = intervention), alpha = 0.3, color = 'black') +
  geom_point(data = dfTRIAL, alpha = 0.5, color = pal[4], shape = 18) +
  geom_smooth(method="lm", color="tomato",fill = pal[4], size=0.7) + #addd this for lsplines
  ggtitle("Post") +
  ylab('')+
  xlab('') +
  scale_y_continuous(expand = c(0, 0),  limits = c(11.5,15.5),  breaks=c(seq.int(12,15, by = 1))) +
  scale_x_continuous(expand = c(0, 0),  limits = c(0,15.2),  breaks=c(1,5,10,15)) +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2, 18)) +
  scale_fill_discrete(name="") +
  theme_bw()


pltpost = pp + averaged_theme + theme(axis.text.x= element_text(size = 14), axis.text.y= element_text(size = 14, color="white"), legend.position=c(.94,.93), plot.title = element_text(hjust = 0.5, size = 20), plot.margin = unit(c(0, 1,-1.5,-2), "cm"))

figure = ggarrange(pltpre, pltpost, labels = c("", ""),
  common.legend = F)


plt = annotate_figure(figure,
bottom = text_grob("Trial", size = 16),
 left = text_grob("Number of Grips \n ", rot = 90, size = 16),
)
plt

```
\
\
```{r INST_saveFIG, echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_INST_trial_LIRA.pdf')
print(plt)
dev.off()
```

# PIT (Pavlovian-Instrumental Transfer) Task
Mobilized effort = Area Under the Curve (AUC) of the force exerted exceeding the delivery threshold during Pavlvovian cue presentation
condition = CS+ or CS-
```{r PIT, echo=FALSE, include=FALSE, cache=TRUE, warning=F}
measurevar = "AUC"
formula = "condition*intervention*session"
COVA = "+ age + gender + BMI_V1  + thirsty  + hungry +"
random = " (condition*session|id) + (1|trialxcondition)"

#method LRT
model = mixed(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = PIT, method = "LRT", control = control, REML = FALSE); model

table = nice(model);  ref_grid(model)  #triple check everything is centered at 0

mod =  lmer(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = PIT, control = control)
tab_model(mod, show.p = F,show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 2, dv.labels = "Mobilized effort", emph.p = TRUE, file = "tmp/temp4.html")
```
\
```{r PIT_mod}
tables <- list.clean(readHTMLTable("tmp/temp4.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)

tables2 <- as.matrix(tables2) %>% as_tibble()
tables2[is.na(tables2)] <- ""
tables3 = tables2[1:length(table$Effect),1:4] 
tables3[5] = str_split(gsub("[^0-9.,-]", "", table[3]), ",")[[1]]; tables3[6] = as.numeric(str_split(gsub("[^0-9.,-]", "", table[4]), ",")[[1]]); 
tables3$...6 = ifelse(tables3$...6 < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",tables3$...6), "</span>"),  paste("<span>" ,sprintf("%.3f",tables3$...6), "</span>"))
colnames(tables3)[5] = "\u03C7\u00B2"; colnames(tables3)[6] = "p"
#tables3$p[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
tables3  %>% kbl(caption ="Mobilized effort (a.u.)",escape = F ) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T,align='c')
tmp = tables2[(length(table$Effect)+1):(length(table$Effect)+5),1:2]
names(tmp) <- NULL
tmp1 <- data.frame(t(tmp[-1]))
colnames(tmp1) <- tmp[[1]]
tmp1 %>% kbl(digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) 

```
\
```{r message = FALSE, echo=FALSE, results='hide', fig.show="hold", out.width="25%", fig.align="center", fig.cap = 'Model assumptions.', warning=F}
x = plot_model(mod, type = "diag")
x[-c(2)]
x[2][[1]]$id
 #check assumptions
```
\
\

```{r PIT_plot, echo=FALSE, warning=FALSE, cache=TRUE, fig.align="center", fig.cap="Mobilized effort by pavlovian cue."}
dfL <- summarySEwithin(PIT.means,
                       measurevar = "AUC",
                       withinvars = c("condition","session"), 
                       idvar = "id")

dfL$cond <- ifelse(dfL$condition == "1", -0.25, 0.25)
PIT.means$cond <- ifelse(PIT.means$condition == "1", -0.25, 0.25)
PIT.means <- PIT.means %>% mutate(condjit = jitter(as.numeric(cond), 0.3),grouping = interaction(id, cond))


# AUC
pp <- ggplot(PIT.means, aes(x = cond, y = AUC,
                            fill = condition, color = condition)) +
  geom_line(aes(x = condjit, group = id, y = AUC), alpha = .3, size = 0.5, color = 'gray' ) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = condition, color = NA)) +
  geom_point(aes(x = condjit, shape = intervention), alpha = .3) +
  geom_crossbar(data = dfL, aes(y = AUC, ymin=AUC-se, ymax=AUC+se), width = 0.2 , alpha = 0.1)+
  ylab('Mobilized effort (a.u.)')+
  xlab('Condition')+
  #scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,30, by = 5)), limits = c(-0.05,30.5)) +
  scale_x_continuous(labels=c("CS+", "CS-"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("1"= pal[6], "-1"=  pal[1]), guide = 'none') +
  scale_color_manual(values=c("1"= pal[6], "-1"=  pal[1]), guide = 'none') +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2)) +
  theme_bw()+ facet_wrap(~session, labeller=labeller(session = labels))



pp + html_theme +theme(legend.position=c(.94,.94))
plt = pp + averaged_theme +theme(legend.position=c(.94,.94))
```
\
\
```{r PIT_save, echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_PIT_Lira.pdf')
print(plt)
dev.off()
```

# Hedonic Reactivity Test 
Perceived liking = how pleasant is the liquid solution rated (0-100, with repetitions)   &   condition = Milshake or Tasteless   &   intensity = difference on how intense the liquid solution were rated 
```{r HED, echo=FALSE, include=FALSE, cache=TRUE, warning=F}
measurevar = "lik"
formula = "condition*intervention*session"
COVA = "+ age + gender + BMI_V1  + thirsty  + hungry + int  + fam +"
#COVA = "+ age + gender + BMI_V1  + thirsty  + hungry + int  + condition*intervention*session*Fast_glu +"
random = " (condition*session| id) + (1|trialxcondition)"

#method LRT
model = mixed(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = HED, method = "LRT", control = control, REML = FALSE); model
table = nice(model);  ref_grid(model)  #triple check everything is centered at 0

mod =  lmer(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = HED, control = control)
tab_model(mod, show.p = F,show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 2, dv.labels = "Perceived liking", emph.p = TRUE, file = "tmp/temp5.html")
```
\
```{r HED_mod}
tables <- list.clean(readHTMLTable("tmp/temp5.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)

tables2 <- as.matrix(tables2) %>% as_tibble()
tables2[is.na(tables2)] <- ""
tables3 = tables2[1:length(table$Effect),1:4] 
tables3[5] = str_split(gsub("[^0-9.,-]", "", table[3]), ",")[[1]]; tables3[6] = as.numeric(str_split(gsub("[^0-9.,-]", "", table[4]), ",")[[1]]); 
tables3$...6 = ifelse(tables3$...6 < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",tables3$...6), "</span>"),  paste("<span>" ,sprintf("%.3f",tables3$...6), "</span>"))
colnames(tables3)[5] = "\u03C7\u00B2"; colnames(tables3)[6] = "p"
tables3$p[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
tables3  %>% kbl(caption ="Perceived liking",escape = F ) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T,align='c')
tmp = tables2[(length(table$Effect)+1):(length(table$Effect)+5),1:2]
names(tmp) <- NULL
tmp1 <- data.frame(t(tmp[-1]))
colnames(tmp1) <- tmp[[1]]
tmp1 %>% kbl(digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) 

```
\
```{r message = FALSE, echo=FALSE, results='hide', fig.show="hold", out.width="25%", fig.align="center", fig.cap = 'Model assumptions.', warning=F}
x = plot_model(mod, type = "diag")
x[-c(2)]
x[2][[1]]$id
 #check assumptions
```
\
\
```{r HED_plot, echo=FALSE, warning=FALSE, cache=TRUE, fig.align="center", fig.cap="Perceived liking (Taste) by solution."}

# AVERAGED EFFECT
dfH <- summarySEwithin(HED.means,
                       measurevar = "lik",
                       withinvars = c("condition","session"), 
                       idvar = "id")

dfH$cond <- ifelse(dfH$condition == "1", -0.25, 0.25)
HED.means$cond <- ifelse(HED.means$condition == "1", -0.25, 0.25)
HED.means <- HED.means %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                                  grouping = interaction(id, cond))


pp <- ggplot(HED.means, aes(x = cond, y = lik, 
                            fill = condition, color = condition)) +
  geom_point(data = dfH, alpha = 0.5) +
  geom_line(aes(x = condjit, group = id, y = lik), alpha = .3, size = 0.5, color = 'gray') +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = condition, color = NA))+
  geom_point(aes(x = condjit, shape = intervention), alpha = .3,) +
  geom_crossbar(data = dfH, aes(y = lik, ymin=lik-se, ymax=lik+se), width = 0.2 , alpha = 0.1)+
  ylab('Perceived liking') +
  xlab('Taste') +
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,100, by = 20)), limits = c(-0.5,100.5)) +
  scale_x_continuous(labels=c("Pleasant", "Neutral"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("1"= pal[3], "-1"=pal[1]), guide = 'none') +
  scale_color_manual(values=c("1"=pal[3], "-1"=pal[1]), guide = 'none') +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2)) +
  theme_bw()+ facet_wrap(~session, labeller=labeller(session = labels))


pp + html_theme +theme(legend.position=c(.96,.94))
plt = pp + averaged_theme +theme(legend.position=c(.96,.94))
```
\
\
```{r HED_saveFIG, echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_HED_Lira.pdf')
print(plt)
dev.off()
```




# fMRI Analysis
check out "analysis_LIRA_fMRI.R" for more details
```{r HED_fmri, echo=FALSE, include = FALSE, warning=FALSE}

mdl.hf = aov_car(data = inter, HF_inter ~ intervention + BMI_diff + age + Error(id), factorize = F, type = "II", anova_table = list(correction = "GG", es = "pes"))
 
res = nice(mdl.hf, MSE=F); ref_grid(mdl.hf)  #triple check everything is centered at 0


#calculate Partial eta-squared and its 90 % CI for each effect
PES.hf = pes_ci(data = inter, HF_inter ~ intervention + BMI_diff + age + Error(id), conf.level = .90, factorize = FALSE, anova.type = "II", epsilon="none") ;  
mdl.hf.emms = emmeans(mdl.hf, pairwise ~ intervention)

```
Contrast Post > Pre in HF 
\
```{r HED_fmri_res, message=F, warning=F}
res$p.value = as.numeric(res$p.value)
res$p.value = ifelse(res$p.value < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",res$p.value), "</span>"),  paste("<span>" ,sprintf("%.3f",res$p.value), "</span>"))

res$F = unlist(str_split(gsub("[^0-9.,-]", "", res$F), ","));res$pes = unlist(str_split(gsub("[^0-9.,-]", "", res$pes), ","));
res$`90% CI` = paste(sprintf("%.3f",PES.hf[,2]), "-", sprintf("%.3f",PES.hf[,3]))

res$p.value[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
#res$pes[c(5,7,8)]= c("\u003C 0.001")
colnames(res)[3:5] = c( paste("F(", res$df[1], ")", sep=""),"&eta;<sub>p</sub><sup>2</sup>", "p")
res[c(1,4,6,3,5)]  %>% kbl(digits = 2, escape = F,row.names = F)  %>%
  kable_styling(latex_options = "striped", position = "center", full_width = F) 
#print('PES: intervention: Overall higher weight loss for treament (Liraglutide) group')
#PES.weight[1,]
```
```{r message = FALSE, echo=FALSE, results='hide', fig.show="hold", out.width="25%", fig.align="center", fig.cap = 'Model assumptions.', warning=F}
mod = lm(HF_inter ~ intervention + BMI_diff + age, data = inter)
x = plot_model(mod, type = "diag")
x[c(2,3,4,1)]
 #check assumptions
```
\
\
```{r HED_fmri_plot, echo=FALSE,  message=FALSE, cache=TRUE, fig.align="right", fig.cap="Beta estimates from hippocampal formation during Hedonic reactivity test (Post > Pre) by intervention and correlation with weight loss.", warning=F}
sp = ggplot(inter, aes(x = `Weight Loss`, y = HF_inter, color = intervention)) +
  stat_ellipse(aes(group=intervention)) +  geom_point(alpha = .3, size = 3) + 
  geom_smooth(method= lm,aes(color = NULL), alpha = 0.5 ) +
  scale_color_manual(name="Intervention", labels = c("Placebo", "Liraglutide"), values=c("0"=pal[1], "1"=pal[6])) +
  theme_bw()+ 
  #stat_cor(aes(color=NULL, label = paste(..rr.label.., sep = "~`,`~")),label.x = 5, label.y = -2.5)+ labs(color = "Intervention")   +  # to add Rsquared 
  guides(color = guide_legend(override.aes = list(fill=NA, size = c(2.5,2.5), linetype = c(0, 0),label = "") ) ) +   ylab('HF Beta estimates (a.u.)') +   xlab('Weight loss (\u0394 BMI)') +   theme(legend.title = element_text(size =12), legend.text = element_text(size = 10), axis.title.x = element_text(size = 24), axis.title.y = element_text(size =  24), legend.position = c(0.94, 0.9)) + 
  border()   

xplot <- ggdensity(inter, "Weight Loss", fill = "intervention") +   scale_fill_manual(values=c("0"= pal[1], "1"=pal[6])) 
yplot <- ggdensity(inter, "HF_inter", fill = "intervention")  + scale_fill_manual(values=c("0"= pal[1], "1"=pal[6])) + rotate()

# Cleaning the plots
yplot <- yplot + clean_theme() + rremove("legend") 
xplot <- xplot + clean_theme() + rremove("legend")

fig = cowplot::plot_grid(xplot, NULL, sp, yplot,ncol = 2, align = "hv", rel_widths = c(2, 1), rel_heights = c(1, 2))
fig
```
```{r HED_fmri_saveFIG, echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_HED_fmri_Weight_HF.pdf')
print(fig)
dev.off()
```

```{r hpp_mediation, cache=T, echo=FALSE, include = FALSE, warning=FALSE}
inter_res <- intmed::mediate(y = "`Weight Loss`", med = "HF", c = c("age"), treat = "Intervention", ymodel = "regression", mmodel = "regression", treat_lv = 1, control_lv = 0, conf.level = 0.95, data = inter, complete_analysis = T, digits = 3, summary_report=F)

tables <- list.clean(readHTMLTable("res.html"), fun = is.null, recursive = FALSE)

#just to plot
medi =  psych::mediate(`Weight Loss` ~ Intervention + (HF) -age, data = inter, plot=F)
```

\
```{r hpp_mediate_res, echo=FALSE, include=T}
table = tables[[3]]
table$Estimates = unlist(str_split(gsub("[^0-9.,-]", "", table$Estimates), ","))

table$`p-value` = as.numeric(table$`p-value`); table$`p-value` = ifelse(as.numeric(table$`p-value`) < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",table$`p-value`), "</span>"),  paste("<span>" ,sprintf("%.3f",table$`p-value`), "</span>"))

table[2:3,4] = "<span style=\" font-weight: bold; \" > \u003C 0.001 <span>"
colnames(table)[4] = "p"
table$p[4] = ""
table %>%
  kbl(caption ="Mediation Analysis: DV = Weight loss, IV = HF activity during reward consumption", escape =F) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)
```
```{r , fig.align="center", fig.cap="Mediation path.", fig.height = 2, fig.width = 7}
par(mar=c(0,0,0,0)); psych::mediate.diagram(medi, show.c = F, main= "", ylim=c(4.5,7.3))
text(3, 6.5, "A ***",  cex = .8); text(7, 6.5, "B *",  cex = .8);  text(5.8, 4.9, "***",  cex = .8); text(5, 6.7, "AB *",  cex = .8)
```
\
```{r HED_fmri_plot_HF, echo=FALSE,  message=FALSE, cache=TRUE, fig.align="right", fig.cap="Beta estimates from hippocampal formation during Hedonic reactivity testby session by intervention.", warning=F}
# AVERAGED EFFECT -------------
dfH <- summarySEwithin(HED_fMRI,
                       measurevar = "HF_score",
                       withinvars = "session",
                       betweenvars = "intervention",
                       idvar = "id")

labels <- c("0" = "Placebo", "1" = "Liraglutide")

HED_fMRI$intervention = as.factor(HED_fMRI$intervention)

dfH$cond <- ifelse(dfH$session == "pre", -0.25, 0.25)
HED_fMRI$cond <- ifelse(HED_fMRI$session == "pre", -0.25, 0.25)
HED_fMRI <- HED_fMRI %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                                  grouping = interaction(id, cond))


pp <- ggplot(HED_fMRI, aes(x = cond, y = HF_score,  fill = intervention, color = intervention)) +
  geom_hline(yintercept = 0, lty=2) +
  geom_point(data = dfH, alpha = 0.5) +
  geom_line(aes(x = condjit, group=id), alpha = 0.2) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(group = session, fill = intervention, color = NA))+
  geom_point(aes(x = condjit), alpha = .3) +
  geom_crossbar(data = dfH, aes(y = HF_score, ymin=HF_score-se, ymax=HF_score+se), width = 0.2 , alpha = 0.1)+
  ylab('Beta estimates HF (a.u.)') +
  xlab('') +
  #scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,100, by = 20)), limits = c(-0.5,100.5)) +
  scale_x_continuous(labels=c("Pre", "Post"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("0"= pal[1], "1"=pal[6]), guide = 'none') +
  scale_color_manual(values=c("0"=pal[1], "1"=pal[6]), guide = 'none') +
  theme_bw()+ facet_wrap(~intervention, labeller=labeller(intervention = labels))


ppp <- pp + averaged_theme
pp + html_theme
```
```{r}
cairo_pdf('figures/Figure_HED_fmri_HF.pdf')
print(ppp)
dev.off()
```

```{r HED_fmri_plot_OFC, echo=FALSE,  message=FALSE, cache=TRUE, fig.align="right", fig.cap="Beta estimates from OFC during Hedonic reactivity test by session by intervention."}
# AVERAGED EFFECT -------------
dfH <- summarySEwithin(HED_fMRI,
                       measurevar = "OFC_score",
                       withinvars = "session",
                       betweenvars = "intervention",
                       idvar = "id")

labels <- c("0" = "Placebo", "1" = "Liraglutide")

HED_fMRI$intervention = as.factor(HED_fMRI$intervention)

dfH$cond <- ifelse(dfH$session == "pre", -0.25, 0.25)
HED_fMRI$cond <- ifelse(HED_fMRI$session == "pre", -0.25, 0.25)
HED_fMRI <- HED_fMRI %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                                  grouping = interaction(id, cond))


pp <- ggplot(HED_fMRI, aes(x = cond, y = OFC_score,  fill = intervention, color = intervention)) +
  geom_hline(yintercept = 0, lty=2) +
  geom_point(data = dfH, alpha = 0.5) +
  geom_line(aes(x = condjit, group=id), alpha = 0.2) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(group = session, fill = intervention, color = NA))+
  geom_point(aes(x = condjit), alpha = .3) +
  geom_crossbar(data = dfH, aes(y = OFC_score, ymin=OFC_score-se, ymax=OFC_score+se), width = 0.2 , alpha = 0.1)+
  ylab('Beta estimates OFC (a.u.)') +
  xlab('') +
  #scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,100, by = 20)), limits = c(-0.5,100.5)) +
  scale_x_continuous(labels=c("Pre", "Post"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("0"= pal[1], "1"=pal[6]), guide = 'none') +
  scale_color_manual(values=c("0"=pal[1], "1"=pal[6]), guide = 'none') +
  theme_bw()+ facet_wrap(~intervention, labeller=labeller(intervention = labels))


ppp <- pp + averaged_theme
pp + html_theme
```
```{r}
cairo_pdf('figures/Figure_HED_fmri_OFC.pdf')
print(ppp)
dev.off()
```
