---
title: "OBIWAN PLACEBO VS. TREATMENT ANALYSIS REPORT"
author: "David Munoz Tord"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:  
    includes:
      in_header: header.html
    css: "style.css"
    code_folding: "hide"
    toc: true
    toc_float: false
    number_sections: false
  pdf_document:
    extra_dependencies: ["float"]
repro:
  data:
    HED: data/HEDONIC.csv
    INST: data/INST.csv
    PAV: data/PAV.csv
    PIT: data/PIT.csv
    intern: data/internal.csv
    medic: data/medic.csv
    HED_fMRI: data/HED_fmri.csv
    
  packages: [ aaronpeikert/repro@devel, crsh/papaja@devel, tinylabels, apaTables, MBESS, afex, ggplot2, ggpubr, Rmisc, emmeans, tidyr, BayesFactor, bayestestR, devtools, lspline, kableExtra, sjPlot, knitr, XML, rlist, janitor, optimx, ggthemes, dplyr, JWileymisc, corrplot, caret, intmed, stringr, cowplot, pander, psych]
  scripts: R/clean.R
  apt:
    - libgsl0-dev
---

### Setup {-}
<!-- # TO DO -->
  
```{r setup, results='hide', message=FALSE, warning=FALSE}

library(repro)
# load packages from yaml header
automate_load_packages()
# include external scripts
automate_load_scripts()

# load data
intern  <- automate_load_data(intern, read.csv, stringsAsFactors = T)
medic    <- automate_load_data(medic, read.csv, stringsAsFactors = T)
PAV      <- automate_load_data(PAV, read.csv, stringsAsFactors = T)
INST     <- automate_load_data(INST, read.csv, stringsAsFactors = T)
PIT      <- automate_load_data(PIT, read.csv, stringsAsFactors = T)
HED      <- automate_load_data(HED, read.csv, stringsAsFactors = T)
HED_fMRI <- automate_load_data(HED_fMRI, read.csv, stringsAsFactors = T)

x = session_info();  opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE) # set F for all


## we recommend running this is a fresh R session or restarting your current session
#install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
#install_cmdstan()


# check_git(); check_make(); check_docker() #check if installed

sessio = session_info(); #opts_chunk$set(echo = F, message=F, warning=F) # set echo F for all
```

This file was automatically created via `the Repro package (version 0.1.0)` using  `r sessio$platform[1]`

<!-- May I suggest running `repro::automate()`? This will create a `Dockerfile` & `Makefile` based on every RMarkdown in this folder and the special yamls in them. date: "`r format(Sys.time(), '%d %B, %Y')`" -->
<!-- add ENV DEBIAN_FRONTEND=noninteractive -->



```{r options, results='hide', message=FALSE, warning=FALSE}
niter = 500; warm = 100; chains = 4; cores = 4; nsim = 10000 # number of iterations (to change if you want to quick check and warmups #or also parallel::detectCores()/2)
options(scipen = 666, warn=-1, contrasts=c("contr.sum","contr.poly"), mc.cores = cores);  #remove scientific notation # remove warnings #set contrasts to sum !
 #cl = parallel::detectCores()/2
set.seed(666) #set random seed
control = lmerControl(optimizer ='optimx', optCtrl=list(method='nlminb')) #set "better" lmer optimizer #nolimit # yoloptimizer
#emm_options(pbkrtest.limit = 8000) #increase repetitions limit for frequentist stats

source('R/plots.R', echo=F)# plot specification
source('R/utils.R', echo=F)# useful functions

panderOptions('knitr.auto.asis', FALSE) #remove auto styling

# Look at R/clean.R (listed in the YAML) which does all the preprocessing for more info

# If you are unsure weather or not you have `git` `make` & `docker`.
# check_git()
# check_make()
# check_docker()
```

```{r clean, echo=FALSE, include=FALSE}
# this chunk runs R/clean.R (listed in the YAML) which does all the preprocessing
```
## Description

<!-- Parametric Bootstrap Test method to evaluate significance of fixed effects in mixed-effects models (using MLE fit, nsim = 5000) and Bayes Factor from mixed models (see Wagenmakers, 2007) -->

### Demographics
```{r demographics}
egltable(c("BMI", "AGE", "GENDER"), 
  g = "intervention", data = df, strict = FALSE) %>%
  kbl(caption ="Summary statistics", digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%
  row_spec(0,bold=T,align='c')
```

### Biomedical data
#### Variable Selection
```{r var_plot, echo=FALSE, warning=FALSE, cache=TRUE, fig.align="center", out.width="90%", fig.cap="Box-plot of all biomedical predictors per intervention."}

# Boxplot of biomedical variables per group
ggplot(med)+
  geom_boxplot(aes(intervention, n))+
  facet_wrap(~feature, scales = "free")+
  labs(title = "")+
  theme_fivethirtyeight()+
  theme(axis.title = element_text()) + 
  ylab("Biomedical predictor's value (scaled)") + 
  xlab('')

# Plot correlogram of numeric variables
#pairs(~., data = df[,8:19], main = "Scatterplot Matrix of variables")
#corrplot(cor(df[,8:19], use="pairwise.complete.obs"), type="lower")

```
\

Recursive Feature Eliminations 
```{r var_sel, echo=FALSE, include=T, cached=T,fig.align="center"}

#1) with Recursive Feature Eliminations (CARET)

sizes = 1:length(dfmed[c(-1)]); len = length(sizes)
seeds <- vector(mode = "list", length = len)
for(i in 1:(len-1)) seeds[[i]]<- sample.int(n=nsim, size = length(sizes)+1)
# for the last model
seeds[[len]]<-sample.int(nsim, 1)

RFEcontrol <- rfeControl(functions=rfFuncs, method="cv", number=10, seeds= seeds) # control options

rfeResults = rfe(x = dfmed[c(-1)], y = dfmed$intervention, sizes=sizes, rfeControl=RFEcontrol)
predictors(rfeResults)
plot(rfeResults, type=c("g", "o")) # look for the "elbow"

#if we agree that BMI, Body Weight and Waist Circumference actually measure the same thing, there only 4 other variables that are "useful" to separate the two groups :
#Reelin and GLP

```

## Mediation analysis (biomedical)
```{r mediate, echo=FALSE, include=F}
df$Intervention = as.numeric(df$intervention)

parallel:::setDefaultClusterOptions(setup_strategy = "sequential")

med_res <- intmed::mediate(y = "weightLoss", med = c("GLP_diff" ,  "reelin_diff"), c = c("age","gender"), treat = "Intervention", ymodel = "regression", mmodel = c("regression", "regression"), treat_lv = 1, control_lv = 0, incint = TRUE, inc_mmint = FALSE, conf.level = 0.95, data = df, sim = nsim, complete_analysis = TRUE, digits = 3,  summary_report=F)

table <- list.clean(readHTMLTable("res.html"), fun = is.null, recursive = FALSE); table = table[4]$`NULL`[1:6,]

```

```{r mediate_res, echo=FALSE, include=T}

#pander(table)
colnames(table)[4] = "p"; table$p = as.numeric(table$p); table$p = ifelse(as.numeric(table$p) < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",table$p), "</span>"),  paste("<span>" ,sprintf("%.3f",table$p), "</span>")) # highlight p < 0.05


table %>%
  kbl(caption ="Mediation Analysis: DV = Weight loss, IV = Intervention", escape=F) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)

#plot
medi =  psych::mediate(weightLoss ~ Intervention + (GLP_diff) + (reelin_diff), data = df, n.iter = nsim, plot=F); psych::mediate.diagram(medi,show.c=FALSE)
```

## Weight Loss
```{r weigth_loss, echo=FALSE, include=FALSE, cache=TRUE}
formula = 'weightLoss ~ intervention + gender + age  + Date_diff + Error(id)'


mdl.weight = aov_car(as.formula(formula), data = df, factorize = FALSE,  anova_table = list(correction = "GG", es = "pes"),type = "II")
res = nice(mdl.weight, MSE = F); ref_grid(mdl.weight); res

PES.weight = pes_ci(as.formula(formula), data = df, conf.level = .90, factorize = FALSE, anova.type = "II", epsilon="none") ; 
mdl.weight.emms = emmeans(mdl.weight, pairwise ~ intervention)

```
```{r weight_res}
res$p.value = as.numeric(res$p.value)
res$p.value = ifelse(res$p.value < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",res$p.value), "</span>"),  paste("<span>" ,sprintf("%.3f",res$p.value), "</span>"))

res$F = unlist(str_split(gsub("[^0-9.,-]", "", res$F), ","));res$pes = unlist(str_split(gsub("[^0-9.,-]", "", res$pes), ","));
res$`90% CI` = paste(sprintf("%.3f",PES.weight[,2]), "-", sprintf("%.3f",PES.weight[,3]))

res$p.value[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
res$pes[4]= "\u003C 0.001"
colnames(res)[3:5] = c( paste("F(", res$df[1], ")", sep=""),"&eta;<sub>p</sub><sup>2</sup>", "p")
res[c(1,4,6,3,5)]  %>% kbl(digits = 2, escape = F) %>%
  kable_styling(latex_options = "striped", position = "center", full_width = F) 
#print('PES: intervention: Overall higher weight loss for treament (Liraglutide) group')
#PES.weight[1,]
```

```{r message = FALSE, echo=FALSE, results='hide', fig.show="hold", out.width="25%", fig.align="center", fig.cap = 'Model assumptions.', warning =FALSE}
mod = lm(weightLoss ~ intervention + gender + age  + Date_diff, data = df)
x = plot_model(mod, type = "diag")
x[c(2,3,4,1)]
 #check assumptions
```

```{r Weight_Loss, echo=FALSE, warning=FALSE, cache=TRUE, fig.align="center", fig.cap="Weight Loss by intervention."}
dfR <- summarySE(df, measurevar = "weightLoss",
                 groupvars = "intervention")

dfR$cond <- ifelse(dfR$intervention == "Liraglutide", -0.25, 0.25)
df$cond <- ifelse(df$intervention == "Liraglutide", -0.25, 0.25)
df <- df %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                    grouping = interaction(id, cond))

pp <- ggplot(df, aes(x = cond, y = weightLoss, 
                     fill = intervention, color = intervention)) +
  geom_hline(yintercept=0, linetype="dashed", size=0.4, alpha=0.8) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = intervention, color = NA))+
  geom_point(aes(x = condjit), alpha = .3,) +
  geom_crossbar(data = dfR, aes(y = weightLoss, ymin=weightLoss-se, ymax=weightLoss+se), width = 0.2 , alpha = 0.1)+
  ylab('Weight loss (\u0394 BMI)')+xlab('')+
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(-2.5,7.5, by = 2.5)), limits = c(-3,8)) +
  scale_x_continuous(labels=c("Liraglutide", "Placebo"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("Liraglutide"= pal[6], "Placebo"=  pal[1]), guide = 'none') +
  scale_color_manual(values=c("Liraglutide"= pal[6], "Placebo"=  pal[1]), guide = 'none') +
  theme_bw() 

plt = pp + averaged_theme 
pp + html_theme 
```
\
\
```{r weight_saveFIG, include=FALSE}
cairo_pdf('figures/Figure_WeightLoss_Lira.pdf')
print(plt)
dev.off()
```

# Pavlvovian Conditioning Task (Latency)
Latency = time to detect the target (ms) &  condition = CS+ or CS- \
```{r PAV_RT, echo=FALSE, include=FALSE, cache=TRUE, warning=FALSE}
# -------------------------------------- RT
measurevar = "RT"
formula = "condition*intervention*session"
COVA = "+ condition*age + gender + BMI_V1  + thirsty  + hungry +"
random = " (condition*session|id) + (1|trialxcondition)"

#method LRT 
model = mixed(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = PAV, method = "LRT", control = control, REML = FALSE); model

table = nice(model);  ref_grid(model)  #triple check everything is centered at 0


mod =  lmer(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = PAV, control = control)
tab_model(mod, show.p = T,show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 2, dv.labels = "Latency", emph.p = TRUE, file = "tmp/temp1.html")
```
\
```{r PAV_RT_mod}
tables <- list.clean(readHTMLTable("tmp/temp1.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)

tables2 <- as.matrix(tables2) %>% as_tibble()
tables2[is.na(tables2)] <- ""
tables3 = tables2[1:length(table$Effect),1:4] 
tables3[5] = str_split(gsub("[^0-9.,-]", "", table[3]), ",")[[1]]; tables3[6] = as.numeric(str_split(gsub("[^0-9.,-]", "", table[4]), ",")[[1]]); 
tables3$...6 = ifelse(tables3$...6 < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",tables3$...6), "</span>"),  paste("<span>" ,sprintf("%.3f",tables3$...6), "</span>"))
colnames(tables3)[5] = "\u03C7\u00B2"; colnames(tables3)[6] = "p"
tables3$p[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
tables3 %>%   
  kbl(caption ="Latency (ms)",escape = F) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T,align='c')
tmp = tables2[(length(table$Effect)+1):(length(table$Effect)+5),1:2]
names(tmp) <- NULL
tmp1 <- data.frame(t(tmp[-1]))
colnames(tmp1) <- tmp[[1]]
tmp1 %>% kbl(digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) 

```
\
```{r message = FALSE, echo=FALSE, results='hide', fig.show="hold", out.width="25%", fig.align="center", fig.cap = 'Model assumptions.', warning=F}
x = plot_model(mod, type = "diag")
x[-c(2)]
x[2][[1]]$id
 #check assumptions
```
\
\

```{r PAV_RT_plot, echo=FALSE, warning=FALSE, cache=TRUE, fig.align="center", fig.cap="Latency by pavlvovian cue."}
# RT
labels <- c("0" = "Pre", "1" = "Post")

dfR <- summarySEwithin(PAV.means,
                       measurevar = "RT",
                       withinvars = c("condition","session"), 
                       idvar = "id")

dfR$cond <- ifelse(dfR$condition == "1", -0.25, 0.25)
PAV.means$cond <- ifelse(PAV.means$condition == "1", -0.25, 0.25)
PAV.means <- PAV.means %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                                  grouping = interaction(id, cond))

pp <- ggplot(PAV.means, aes(x = cond, y = RT, 
                            fill = condition, color = condition)) +
  geom_line(aes(x = condjit, group = id, y = RT), alpha = .3, size = 0.5, color = 'gray') +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = condition, color = NA))+
  geom_point(aes(x = condjit, shape = intervention), alpha = .3,) +
  geom_crossbar(data = dfR, aes(y = RT, ymin=RT-se, ymax=RT+se), width = 0.2 , alpha = 0.1)+
  ylab('Latency (ms)')+
  xlab('Conditioned stimulus')+
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(200,1000, by = 200)), limits = c(150,1050)) +
  scale_x_continuous(labels=c("CS+", "CS-"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_color_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2)) +
  theme_bw() + facet_wrap(~session, labeller=labeller(session = labels))

plt = pp + averaged_theme  + theme(legend.position=c(.96,.94), axis.text.x = element_text(size = 14))
pp + html_theme  + theme(legend.position=c(.96,.94), axis.text.x = element_text(size = 14))
```
```{r PAV_RT_saveFIG, include=FALSE}
cairo_pdf('figures/Figure_PavlovianRT_Lira.pdf')
print(plt)
dev.off()
```
### (Part 2) Pavlvovian Conditioning Task (Pleasantness Ratings)
Ratings = how pleasant is the clue (0-100, no repetitions)   &   condition = CS+ or CS-
```{r PAV_Lik, cache=TRUE, include=FALSE, message=FALSE, warning=FALSE}
# -------------------------------------- Liking
measurevar = "liking"
formula = "condition*intervention*session"
COVA = "+ age + gender + BMI_V1 + "
random = "Error(id/session*condition)"

 
mdl.lik = aov_car(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data= PAV.means, factorize = F, anova_table = list(correction = "GG", es = "pes"))
res = nice(mdl.lik, MSE=F);  res = res[c(10,1:6,11,15,16),] #clean up unesuful an reorder
ref_grid(mdl.lik)  #triple check everything is centered at 0


#calculate Partial eta-squared and its 90 % CI for each effect
PES.lik = pes_ci(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = PAV.means, conf.level = .90, factorize = FALSE, anova.type = "II", epsilon="none") ;  PES.lik = PES.lik[c(10,1:6,11,15,16),]
mdl.lik.emms = emmeans(mdl.lik, pairwise ~ condition)

#calculate exclusion BF01 for each effect
# test = extractBF(generalTestBF(as.formula(paste(measurevar, paste (formula, COVA, 'id'), sep="~")), data= PAV.means, whichRandom = 'id', neverExclude =  'id', whichModels ="top")); BF = 1/test[1] #switch to BF10 inclusion)); BF = 1/test[1] #switch to BF10 inclusion
# table$BF10 = rev(BF$bf) # reorder to match lmer model
# 
# tab_model(mod, show.p = F,show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 2, dv.labels = "Pleasantness Ratings", emph.p = TRUE, file = "tmp/temp2.html")
```
```{r PAV_Lik_res, warning=FALSE}
res$p.value = as.numeric(res$p.value)
res$p.value = ifelse(res$p.value < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",res$p.value), "</span>"),  paste("<span>" ,sprintf("%.3f",res$p.value), "</span>"))

res$F = unlist(str_split(gsub("[^0-9.,-]", "", res$F), ","));res$pes = unlist(str_split(gsub("[^0-9.,-]", "", res$pes), ","));
res$`90% CI` = paste(sprintf("%.3f",PES.lik[,2]), "-", sprintf("%.3f",PES.lik[,3]))

res$p.value[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
res$pes[c(5,7,8)]= c("\u003C 0.001")
colnames(res)[3:5] = c( paste("F(", res$df[1], ")", sep=""),"&eta;<sub>p</sub><sup>2</sup>", "p")
res[c(1,4,6,3,5)]  %>% kbl(digits = 2, escape = F,row.names = F)  %>%
  kable_styling(latex_options = "striped", position = "center", full_width = F) 
#print('PES: intervention: Overall higher weight loss for treament (Liraglutide) group')
#PES.weight[1,]
```
```{r message = FALSE, cache =T, echo=FALSE, results='hide', fig.show="hold", out.width="25%", fig.align="center", fig.cap = 'Model assumptions.'}
mod = lmer(as.formula(paste(measurevar, paste (formula, COVA, '(condition+session|id)'), sep="~")), data = PAV.means, control = control)
x = plot_model(mod, type = "diag")
x[c(1,3,4,2)]
 #check assumptions
```
\
\

```{r PAV_LIK_plot, echo=FALSE, warning=FALSE, cache=TRUE, fig.align="center", fig.cap="Pleasantness Ratings by pavlvovian cue."}

dfL <- summarySEwithin(PAV.means,
                       measurevar = "liking",
                       withinvars = c("condition", "session"), 
                       idvar = "id")

dfL$cond <- ifelse(dfL$condition == "1", -0.25, 0.25)

# Liking
pp <- ggplot(PAV.means, aes(x = cond, y = liking, 
                            fill = condition, color = condition)) +
  geom_hline(yintercept=50, linetype="dashed", size=0.4, alpha=0.8) +
  geom_line(aes(x = condjit, group = id, y = liking), alpha = .3, size = 0.5, color = 'gray' ) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = condition, color = NA)) +
  geom_point(aes(x = condjit, shape = intervention), alpha = .3) +
  geom_crossbar(data = dfL, aes(y = liking, ymin=liking-se, ymax=liking+se), width = 0.2 , alpha = 0.1)+
  ylab('Liking Ratings')+
  xlab('Conditioned stimulus')+
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,100, by = 25)), limits = c(-0.05,100.5)) +
  scale_x_continuous(labels=c("CS+", "CS-"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_color_manual(values=c("1"= pal[2], "-1"=  pal[1]), guide = 'none') +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2)) +
  theme_bw()+ facet_wrap(~session, labeller=labeller(session = labels))


plt = pp + averaged_theme  + theme(legend.position=c(.96,.94), axis.text.x = element_text(size = 14))
pp + html_theme  + theme(legend.position=c(.96,.94), axis.text.x = element_text(size = 14))
```
\
\
```{r PAV_lik_saveFIG, include=FALSE}
cairo_pdf('figures/Figure_PavlovianLiking_Lira.pdf')
print(plt)
dev.off()
```

# Instrumental Conditioning Task (Analysis)
grips = number of times participant exceeded the force threshold to acquire the reward (Milkshake)
spline = first 5 trials (1st degree), last 20 trials (2nd degree)

```{r INST, cache=TRUE,  include=FALSE, message=FALSE, warning=FALSE}

measurevar = "grips"
formula = "intervention*session"
COVA = "+ age + gender + BMI_V1  + session*thirsty  + hungry +"
random = '(session|id) + (1|trial)'

model = mixed(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = INST, method = "LRT", control = control, REML = FALSE); model

## FACTORIAL EARLY/LATE LEARNING PHASIS
facmod <- lm(grips ~ phasis*session,data=dfTrial)
#LINEAR FIT
linmod <- lm(grips ~ Trial*session,data=dfTrial)
## QUADRATIC FIT  
quadmod <- lm(grips ~ T2*session,data=dfTrial)
## PIECEWISE REGRESSION WITH SPLINES
splinemod <- lm(grips ~ lspline(Trial,-1.07)*session,data=dfTrial) #1.07 = the standardized end of early phase of learning

BF_fit = as_tibble(bayesfactor_models(facmod, linmod, quadmod, splinemod, denominator = facmod)); 
```
```{r INST_learning_MS, cache=TRUE}
#print('BF10 for model piecewise regression model ')
#BF_fit$BF[2]
BF_fit$Model = c("Factorial early/late Learning Phasis", "Linear Time Fit", "Quadratic Time Fit", "Piecewise Regression with Splines")
BF_fit$BF10 = formatC(BF_fit$BF, format = "e", digits = 2); BF_fit$BF10[1] = 1; BF_fit = BF_fit[-c(2)]
kbl(as_tibble(BF_fit), caption = "Bayesian Model Comparison", digits = 1) %>%   kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)  %>%  row_spec(0,bold=T,align='c')
```
\
```{r INST_m, cache=TRUE,  include=FALSE, message=FALSE, warning=FALSE}
mod <- lmer(as.formula(paste(measurevar, paste(formula, COVA, random), sep="~")),data=INST, control = control)

table = nice(model);  ref_grid(model)

tab_model(mod, show.p = F,show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 2, dv.labels = "Grips", emph.p = TRUE, file = "tmp/temp3.html")
```
\
```{r INST_mod}
tables <- list.clean(readHTMLTable("tmp/temp3.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)

tables2 <- as.matrix(tables2) %>% as_tibble()
tables2[is.na(tables2)] <- ""
tables3 = tables2[1:length(table$Effect),1:4] 
tables3[5] = str_split(gsub("[^0-9.,-]", "", table[3]), ",")[[1]]; tables3[6] = as.numeric(str_split(gsub("[^0-9.,-]", "", table[4]), ",")[[1]]); 
tables3$...6 = ifelse(tables3$...6 < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",tables3$...6), "</span>"),  paste("<span>" ,sprintf("%.3f",tables3$...6), "</span>"))

colnames(tables3)[5] = "\u03C7\u00B2"; colnames(tables3)[6] = "p"
# tables3$p[3]= "<span style=\" font-weight: bold;    \" >\u003C 0.300</span>"
tables3 %>% kbl(caption ="Grips",escape = F ) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T,align='c')
tmp = tables2[(length(table$Effect)+1):(length(table$Effect)+5),1:2]
names(tmp) <- NULL
tmp1 <- data.frame(t(tmp[-1]))
colnames(tmp1) <- tmp[[1]]
tmp1 %>% kbl(digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) 

```
\
```{r message = FALSE, echo=FALSE, results='hide', fig.show="hold", out.width="25%", fig.align="center", fig.cap = 'Model assumptions.', warning=F}
x = plot_model(mod, type = "diag")
x[-c(2)]
x[2][[1]]$id
 #check assumptions
```
\
\
```{r INST_plot, echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, fig.align="center", fig.cap="Number of Grips over time by session."}
INSTPRE = subset(INST, session == 0)
INSTPOST = subset(INST, session == 1)

#--------------------------PRE
dfTRIAL <- summarySEwithin(INSTPRE, na.rm=TRUE,
                           measurevar = "grips",
                           withinvars = c("trial","session"),
                           idvar = "id")

dfTRIAL$trial       <- as.numeric(dfTRIAL$trial)

dfTRIALg <- summarySEwithin(INSTPRE, na.rm=TRUE,
                            measurevar = "grips",
                            withinvars = c("trial","session"),
                            betweenvars = "intervention",
                            idvar = "id")

dfTRIALg$trial       <- as.numeric(dfTRIALg$trial)

dfTRIAL$x = dfTRIAL$trial; dfTRIAL$y = dfTRIAL$grips
splinelm <- lm(y ~ lspline(x, 5), data=dfTRIAL)

pp <- ggplot(dfTRIAL, aes(x =trial, y = grips)) +
  geom_point(data = dfTRIALg, aes(shape = intervention), alpha = 0.3, color = 'black') +
  geom_point(data = dfTRIAL, aes(fill = "Mean"), alpha = 0.5, color = pal[4], shape = 18) +
  geom_smooth(method="lm", formula=formula(splinelm), color="tomato",fill = pal[4], size=0.7) + #addd this for lsplines
  ylab('')+
  xlab('') +
  ggtitle("Pre") +
  scale_y_continuous(expand = c(0, 0),  limits = c(11.5,15.5),  breaks=c(seq.int(12,15, by = 1))) +
  scale_x_continuous(expand = c(0, 0),  limits = c(0,15.2),  breaks=c(1,5,10,15)) +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2, 18)) +
  scale_fill_discrete(name="") +
  guides(shape = FALSE) + 
  theme_bw()

pltpre = pp + averaged_theme + theme(axis.text.x= element_text(size = 14), axis.text.y= element_text(size = 14), legend.position=c(.94,.99), plot.title = element_text(hjust = 0.5, size = 20), plot.margin = unit(c(0, 1,-1.5,-2), "cm"))

#-------------------------------POST
dfTRIAL <- summarySEwithin(INSTPOST, na.rm=TRUE,
                           measurevar = "grips",
                           withinvars = c("trial","session"),
                           idvar = "id")

dfTRIAL$trial       <- as.numeric(dfTRIAL$trial)

dfTRIALg <- summarySEwithin(INSTPOST, na.rm=TRUE,
                            measurevar = "grips",
                            withinvars = c("trial","session"),
                            betweenvars = "intervention",
                            idvar = "id")

dfTRIALg$trial       <- as.numeric(dfTRIALg$trial)

dfTRIAL$x = dfTRIAL$trial; dfTRIAL$y = dfTRIAL$grips

pp <- ggplot(dfTRIAL, aes(x =trial, y = grips)) +
  geom_point(data = dfTRIALg, aes(shape = intervention), alpha = 0.3, color = 'black') +
  geom_point(data = dfTRIAL, alpha = 0.5, color = pal[4], shape = 18) +
  geom_smooth(method="lm", color="tomato",fill = pal[4], size=0.7) + #addd this for lsplines
  ggtitle("Post") +
  ylab('')+
  xlab('') +
  scale_y_continuous(expand = c(0, 0),  limits = c(11.5,15.5),  breaks=c(seq.int(12,15, by = 1))) +
  scale_x_continuous(expand = c(0, 0),  limits = c(0,15.2),  breaks=c(1,5,10,15)) +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2, 18)) +
  scale_fill_discrete(name="") +
  theme_bw()


pltpost = pp + averaged_theme + theme(axis.text.x= element_text(size = 14), axis.text.y= element_text(size = 14, color="white"), legend.position=c(.94,.93), plot.title = element_text(hjust = 0.5, size = 20), plot.margin = unit(c(0, 1,-1.5,-2), "cm"))

figure = ggarrange(pltpre, pltpost, labels = c("", ""),
  common.legend = F)


plt = annotate_figure(figure,
bottom = text_grob("Trial", size = 16),
 left = text_grob("Number of Grips \n ", rot = 90, size = 16),
)
plt

```
\
\
```{r INST_saveFIG, echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_INST_trial_LIRA.pdf')
print(plt)
dev.off()
```

# PIT (Pavlovian-Instrumental Transfer) Task
Mobilized effort = Area Under the Curve (AUC) of the force exerted exceeding the delivery threshold during Pavlvovian cue presentation
condition = CS+ or CS-
```{r PIT, echo=FALSE, include=FALSE, cache=TRUE, warning=F}
measurevar = "AUC"
formula = "condition*intervention*session"
COVA = "+ age + gender + BMI_V1  + thirsty  + hungry +"
random = " (condition*session|id) + (1|trialxcondition)"

#method LRT
model = mixed(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = PIT, method = "LRT", control = control, REML = FALSE); model

table = nice(model);  ref_grid(model)  #triple check everything is centered at 0

mod =  lmer(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = PIT, control = control)
tab_model(mod, show.p = F,show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 2, dv.labels = "Mobilized effort", emph.p = TRUE, file = "tmp/temp4.html")
```
\
```{r PIT_mod}
tables <- list.clean(readHTMLTable("tmp/temp4.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)

tables2 <- as.matrix(tables2) %>% as_tibble()
tables2[is.na(tables2)] <- ""
tables3 = tables2[1:length(table$Effect),1:4] 
tables3[5] = str_split(gsub("[^0-9.,-]", "", table[3]), ",")[[1]]; tables3[6] = as.numeric(str_split(gsub("[^0-9.,-]", "", table[4]), ",")[[1]]); 
tables3$...6 = ifelse(tables3$...6 < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",tables3$...6), "</span>"),  paste("<span>" ,sprintf("%.3f",tables3$...6), "</span>"))
colnames(tables3)[5] = "\u03C7\u00B2"; colnames(tables3)[6] = "p"
#tables3$p[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
tables3  %>% kbl(caption ="Mobilized effort (a.u.)",escape = F ) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T,align='c')
tmp = tables2[(length(table$Effect)+1):(length(table$Effect)+5),1:2]
names(tmp) <- NULL
tmp1 <- data.frame(t(tmp[-1]))
colnames(tmp1) <- tmp[[1]]
tmp1 %>% kbl(digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) 

```
\
```{r message = FALSE, echo=FALSE, results='hide', fig.show="hold", out.width="25%", fig.align="center", fig.cap = 'Model assumptions.', warning=F}
x = plot_model(mod, type = "diag")
x[-c(2)]
x[2][[1]]$id
 #check assumptions
```
\
\

```{r PIT_plot, echo=FALSE, warning=FALSE, cache=TRUE, fig.align="center", fig.cap="Mobilized effort by pavlovian cue."}
dfL <- summarySEwithin(PIT.means,
                       measurevar = "AUC",
                       withinvars = c("condition","session"), 
                       idvar = "id")

dfL$cond <- ifelse(dfL$condition == "1", -0.25, 0.25)
PIT.means$cond <- ifelse(PIT.means$condition == "1", -0.25, 0.25)
PIT.means <- PIT.means %>% mutate(condjit = jitter(as.numeric(cond), 0.3),grouping = interaction(id, cond))


# AUC
pp <- ggplot(PIT.means, aes(x = cond, y = AUC,
                            fill = condition, color = condition)) +
  geom_line(aes(x = condjit, group = id, y = AUC), alpha = .3, size = 0.5, color = 'gray' ) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = condition, color = NA)) +
  geom_point(aes(x = condjit, shape = intervention), alpha = .3) +
  geom_crossbar(data = dfL, aes(y = AUC, ymin=AUC-se, ymax=AUC+se), width = 0.2 , alpha = 0.1)+
  ylab('Mobilized effort (a.u.)')+
  xlab('Condition')+
  #scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,30, by = 5)), limits = c(-0.05,30.5)) +
  scale_x_continuous(labels=c("CS+", "CS-"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("1"= pal[6], "-1"=  pal[1]), guide = 'none') +
  scale_color_manual(values=c("1"= pal[6], "-1"=  pal[1]), guide = 'none') +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2)) +
  theme_bw()+ facet_wrap(~session, labeller=labeller(session = labels))



pp + html_theme +theme(legend.position=c(.94,.94))
plt = pp + averaged_theme +theme(legend.position=c(.94,.94))
```
\
\
```{r PIT_save, echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_PIT_Lira.pdf')
print(plt)
dev.off()
```

# Hedonic Reactivity Test 
Perceived liking = how pleasant is the liquid solution rated (0-100, with repetitions)   &   condition = Milshake or Tasteless   &   intensity = difference on how intense the liquid solution were rated 
```{r HED, echo=FALSE, include=FALSE, cache=TRUE, warning=F}
measurevar = "lik"
formula = "condition*intervention*session"
COVA = "+ age + gender + BMI_V1  + thirsty  + hungry + int  + fam +"
#COVA = "+ age + gender + BMI_V1  + thirsty  + hungry + int  + condition*intervention*session*Fast_glu +"
random = " (condition*session| id) + (1|trialxcondition)"

#method LRT
model = mixed(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = HED, method = "LRT", control = control, REML = FALSE); model
table = nice(model);  ref_grid(model)  #triple check everything is centered at 0

mod =  lmer(as.formula(paste(measurevar, paste (formula, COVA, random), sep="~")), data = HED, control = control)
tab_model(mod, show.p = F,show.intercept = F, show.se = T, title ="", show.re.var = F, digits = 2, dv.labels = "Perceived liking", emph.p = TRUE, file = "tmp/temp5.html")
```
\
```{r HED_mod}
tables <- list.clean(readHTMLTable("tmp/temp5.html"), fun = is.null, recursive = FALSE)
tables2 = tables[[1]] %>% janitor::row_to_names(row_number = 1)

tables2 <- as.matrix(tables2) %>% as_tibble()
tables2[is.na(tables2)] <- ""
tables3 = tables2[1:length(table$Effect),1:4] 
tables3[5] = str_split(gsub("[^0-9.,-]", "", table[3]), ",")[[1]]; tables3[6] = as.numeric(str_split(gsub("[^0-9.,-]", "", table[4]), ",")[[1]]); 
tables3$...6 = ifelse(tables3$...6 < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",tables3$...6), "</span>"),  paste("<span>" ,sprintf("%.3f",tables3$...6), "</span>"))
colnames(tables3)[5] = "\u03C7\u00B2"; colnames(tables3)[6] = "p"
tables3$p[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
tables3  %>% kbl(caption ="Perceived liking",escape = F ) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) %>%  row_spec(0,bold=T,align='c')
tmp = tables2[(length(table$Effect)+1):(length(table$Effect)+5),1:2]
names(tmp) <- NULL
tmp1 <- data.frame(t(tmp[-1]))
colnames(tmp1) <- tmp[[1]]
tmp1 %>% kbl(digits = 2) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F) 

```
\
```{r message = FALSE, echo=FALSE, results='hide', fig.show="hold", out.width="25%", fig.align="center", fig.cap = 'Model assumptions.', warning=F}
x = plot_model(mod, type = "diag")
x[-c(2)]
x[2][[1]]$id
 #check assumptions
```
\
\
```{r HED_plot, echo=FALSE, warning=FALSE, cache=TRUE, fig.align="center", fig.cap="Perceived liking (Taste) by solution."}

# AVERAGED EFFECT
dfH <- summarySEwithin(HED.means,
                       measurevar = "lik",
                       withinvars = c("condition","session"), 
                       idvar = "id")

dfH$cond <- ifelse(dfH$condition == "1", -0.25, 0.25)
HED.means$cond <- ifelse(HED.means$condition == "1", -0.25, 0.25)
HED.means <- HED.means %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                                  grouping = interaction(id, cond))


pp <- ggplot(HED.means, aes(x = cond, y = lik, 
                            fill = condition, color = condition)) +
  geom_point(data = dfH, alpha = 0.5) +
  geom_line(aes(x = condjit, group = id, y = lik), alpha = .3, size = 0.5, color = 'gray') +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(fill = condition, color = NA))+
  geom_point(aes(x = condjit, shape = intervention), alpha = .3,) +
  geom_crossbar(data = dfH, aes(y = lik, ymin=lik-se, ymax=lik+se), width = 0.2 , alpha = 0.1)+
  ylab('Perceived liking') +
  xlab('Taste') +
  scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,100, by = 20)), limits = c(-0.5,100.5)) +
  scale_x_continuous(labels=c("Pleasant", "Neutral"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("1"= pal[3], "-1"=pal[1]), guide = 'none') +
  scale_color_manual(values=c("1"=pal[3], "-1"=pal[1]), guide = 'none') +
  scale_shape_manual(name="Intervention", labels=c("Placebo", "Liraglutide"), values = c(1, 2)) +
  theme_bw()+ facet_wrap(~session, labeller=labeller(session = labels))


pp + html_theme +theme(legend.position=c(.96,.94))
plt = pp + averaged_theme +theme(legend.position=c(.96,.94))
```
\
\
```{r HED_saveFIG, echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_HED_Lira.pdf')
print(plt)
dev.off()
```




# fMRI Analysis
check out "analysis_LIRA_fMRI.R" for more details
```{r HED_fmri, echo=FALSE, include = FALSE, warning=FALSE}

mdl.hf = aov_car(data = inter, HF_inter ~ intervention + BMI_diff + age + Error(id), factorize = F, type = "II", anova_table = list(correction = "GG", es = "pes"))
 
res = nice(mdl.hf, MSE=F); ref_grid(mdl.hf)  #triple check everything is centered at 0


#calculate Partial eta-squared and its 90 % CI for each effect
PES.hf = pes_ci(data = inter, HF_inter ~ intervention + BMI_diff + age + Error(id), conf.level = .90, factorize = FALSE, anova.type = "II", epsilon="none") ;  
mdl.hf.emms = emmeans(mdl.hf, pairwise ~ intervention)

```
Contrast Post > Pre in HF 
\
```{r HED_fmri_res, message=F, warning=F}
res$p.value = as.numeric(res$p.value)
res$p.value = ifelse(res$p.value < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",res$p.value), "</span>"),  paste("<span>" ,sprintf("%.3f",res$p.value), "</span>"))

res$F = unlist(str_split(gsub("[^0-9.,-]", "", res$F), ","));res$pes = unlist(str_split(gsub("[^0-9.,-]", "", res$pes), ","));
res$`90% CI` = paste(sprintf("%.3f",PES.hf[,2]), "-", sprintf("%.3f",PES.hf[,3]))

res$p.value[1]= "<span style=\" font-weight: bold;    \" >\u003C 0.001</span>"
#res$pes[c(5,7,8)]= c("\u003C 0.001")
colnames(res)[3:5] = c( paste("F(", res$df[1], ")", sep=""),"&eta;<sub>p</sub><sup>2</sup>", "p")
res[c(1,4,6,3,5)]  %>% kbl(digits = 2, escape = F,row.names = F)  %>%
  kable_styling(latex_options = "striped", position = "center", full_width = F) 
#print('PES: intervention: Overall higher weight loss for treament (Liraglutide) group')
#PES.weight[1,]
```
```{r message = FALSE, echo=FALSE, results='hide', fig.show="hold", out.width="25%", fig.align="center", fig.cap = 'Model assumptions.', warning=F}
mod = lm(HF_inter ~ intervention + BMI_diff + age, data = inter)
x = plot_model(mod, type = "diag")
x[c(2,3,4,1)]
 #check assumptions
```
\
\
```{r HED_fmri_plot, echo=FALSE,  message=FALSE, cache=TRUE, fig.align="right", fig.cap="Beta estimates from hippocampal formation during Hedonic reactivity test (Post > Pre) by intervention and correlation with weight loss.", warning=F}
sp = ggplot(inter, aes(x = `Weight Loss`, y = HF_inter, color = intervention)) +
  stat_ellipse(aes(group=intervention)) +  geom_point(alpha = .3, size = 3) + 
  geom_smooth(method= lm,aes(color = NULL), alpha = 0.5 ) +
  scale_color_manual(name="Intervention", labels = c("Placebo", "Liraglutide"), values=c("0"=pal[1], "1"=pal[6])) +
  theme_bw()+ 
  #stat_cor(aes(color=NULL, label = paste(..rr.label.., sep = "~`,`~")),label.x = 5, label.y = -2.5)+ labs(color = "Intervention")   +  # to add Rsquared 
  guides(color = guide_legend(override.aes = list(fill=NA, size = c(2.5,2.5), linetype = c(0, 0),label = "") ) ) +   ylab('HF Beta estimates (a.u.)') +   xlab('Weight loss (\u0394 BMI)') +   theme(legend.title = element_text(size =12), legend.text = element_text(size = 10), axis.title.x = element_text(size = 24), axis.title.y = element_text(size =  24), legend.position = c(0.94, 0.9)) + 
  border()   

xplot <- ggdensity(inter, "Weight Loss", fill = "intervention") +   scale_fill_manual(values=c("0"= pal[1], "1"=pal[6])) 
yplot <- ggdensity(inter, "HF_inter", fill = "intervention")  + scale_fill_manual(values=c("0"= pal[1], "1"=pal[6])) + rotate()

# Cleaning the plots
yplot <- yplot + clean_theme() + rremove("legend") 
xplot <- xplot + clean_theme() + rremove("legend")

fig = cowplot::plot_grid(xplot, NULL, sp, yplot,ncol = 2, align = "hv", rel_widths = c(2, 1), rel_heights = c(1, 2))
fig
```
```{r HED_fmri_saveFIG, echo=FALSE, include = FALSE, warning=FALSE}
cairo_pdf('figures/Figure_HED_fmri_Weight_HF.pdf')
print(fig)
dev.off()
```

```{r hpp_mediation, cache=T, echo=FALSE, include = FALSE, warning=FALSE}
inter_res <- intmed::mediate(y = "`Weight Loss`", med = "HF", c = c("age"), treat = "Intervention", ymodel = "regression", mmodel = "regression", treat_lv = 1, control_lv = 0, conf.level = 0.95, data = inter, complete_analysis = T, digits = 3, summary_report=F)

tables <- list.clean(readHTMLTable("res.html"), fun = is.null, recursive = FALSE)

#just to plot
medi =  psych::mediate(`Weight Loss` ~ Intervention + (HF) -age, data = inter, plot=F)
```

\
```{r hpp_mediate_res, echo=FALSE, include=T}
table = tables[[3]]
table$Estimates = unlist(str_split(gsub("[^0-9.,-]", "", table$Estimates), ","))

table$`p-value` = as.numeric(table$`p-value`); table$`p-value` = ifelse(as.numeric(table$`p-value`) < 0.05,paste("<span style=\" font-weight: bold; \" >" ,sprintf("%.3f",table$`p-value`), "</span>"),  paste("<span>" ,sprintf("%.3f",table$`p-value`), "</span>"))

table[2:3,4] = "<span style=\" font-weight: bold; \" > \u003C 0.001 <span>"
colnames(table)[4] = "p"
table$p[4] = ""
table %>%
  kbl(caption ="Mediation Analysis: DV = Weight loss, IV = HF activity during reward consumption", escape =F) %>%
  kable_styling(latex_options = "HOLD_position", position = "center", full_width = F)
```
```{r , fig.align="center", fig.cap="Mediation path.", fig.height = 2, fig.width = 7}
par(mar=c(0,0,0,0)); psych::mediate.diagram(medi, show.c = F, main= "", ylim=c(4.5,7.3))
text(3, 6.5, "A ***",  cex = .8); text(7, 6.5, "B *",  cex = .8);  text(5.8, 4.9, "***",  cex = .8); text(5, 6.7, "AB *",  cex = .8)
```
\
```{r HED_fmri_plot_HF, echo=FALSE,  message=FALSE, cache=TRUE, fig.align="right", fig.cap="Beta estimates from hippocampal formation during Hedonic reactivity testby session by intervention.", warning=F}
# AVERAGED EFFECT -------------
dfH <- summarySEwithin(HED_fMRI,
                       measurevar = "HF_score",
                       withinvars = "session",
                       betweenvars = "intervention",
                       idvar = "id")

labels <- c("0" = "Placebo", "1" = "Liraglutide")

HED_fMRI$intervention = as.factor(HED_fMRI$intervention)

dfH$cond <- ifelse(dfH$session == "pre", -0.25, 0.25)
HED_fMRI$cond <- ifelse(HED_fMRI$session == "pre", -0.25, 0.25)
HED_fMRI <- HED_fMRI %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                                  grouping = interaction(id, cond))


pp <- ggplot(HED_fMRI, aes(x = cond, y = HF_score,  fill = intervention, color = intervention)) +
  geom_hline(yintercept = 0, lty=2) +
  geom_point(data = dfH, alpha = 0.5) +
  geom_line(aes(x = condjit, group=id), alpha = 0.2) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(group = session, fill = intervention, color = NA))+
  geom_point(aes(x = condjit), alpha = .3) +
  geom_crossbar(data = dfH, aes(y = HF_score, ymin=HF_score-se, ymax=HF_score+se), width = 0.2 , alpha = 0.1)+
  ylab('Beta estimates HF (a.u.)') +
  xlab('') +
  #scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,100, by = 20)), limits = c(-0.5,100.5)) +
  scale_x_continuous(labels=c("Pre", "Post"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("0"= pal[1], "1"=pal[6]), guide = 'none') +
  scale_color_manual(values=c("0"=pal[1], "1"=pal[6]), guide = 'none') +
  theme_bw()+ facet_wrap(~intervention, labeller=labeller(intervention = labels))


ppp <- pp + averaged_theme
pp + html_theme
```
```{r}
cairo_pdf('figures/Figure_HED_fmri_HF.pdf')
print(ppp)
dev.off()
```

```{r HED_fmri_plot_OFC, echo=FALSE,  message=FALSE, cache=TRUE, fig.align="right", fig.cap="Beta estimates from OFC during Hedonic reactivity test by session by intervention."}
# AVERAGED EFFECT -------------
dfH <- summarySEwithin(HED_fMRI,
                       measurevar = "OFC_score",
                       withinvars = "session",
                       betweenvars = "intervention",
                       idvar = "id")

labels <- c("0" = "Placebo", "1" = "Liraglutide")

HED_fMRI$intervention = as.factor(HED_fMRI$intervention)

dfH$cond <- ifelse(dfH$session == "pre", -0.25, 0.25)
HED_fMRI$cond <- ifelse(HED_fMRI$session == "pre", -0.25, 0.25)
HED_fMRI <- HED_fMRI %>% mutate(condjit = jitter(as.numeric(cond), 0.3),
                                  grouping = interaction(id, cond))


pp <- ggplot(HED_fMRI, aes(x = cond, y = OFC_score,  fill = intervention, color = intervention)) +
  geom_hline(yintercept = 0, lty=2) +
  geom_point(data = dfH, alpha = 0.5) +
  geom_line(aes(x = condjit, group=id), alpha = 0.2) +
  geom_flat_violin(scale = "count", trim = FALSE, alpha = .2, aes(group = session, fill = intervention, color = NA))+
  geom_point(aes(x = condjit), alpha = .3) +
  geom_crossbar(data = dfH, aes(y = OFC_score, ymin=OFC_score-se, ymax=OFC_score+se), width = 0.2 , alpha = 0.1)+
  ylab('Beta estimates OFC (a.u.)') +
  xlab('') +
  #scale_y_continuous(expand = c(0, 0), breaks = c(seq.int(0,100, by = 20)), limits = c(-0.5,100.5)) +
  scale_x_continuous(labels=c("Pre", "Post"),breaks = c(-.25,.25), limits = c(-.5,.5)) +
  scale_fill_manual(values=c("0"= pal[1], "1"=pal[6]), guide = 'none') +
  scale_color_manual(values=c("0"=pal[1], "1"=pal[6]), guide = 'none') +
  theme_bw()+ facet_wrap(~intervention, labeller=labeller(intervention = labels))


ppp <- pp + averaged_theme
pp + html_theme
```
```{r}
cairo_pdf('figures/Figure_HED_fmri_OFC.pdf')
print(ppp)
dev.off()
```
